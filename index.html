<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Happens: Understanding Insurance</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ABeeZee:ital@0;1&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Libre Baskerville', serif;
            background: linear-gradient(135deg, #1e1d4c 0%, #80b2e8 100%);
            min-height: 100vh;
            color: #1e1d4c;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .display-container {
            max-width: 100vw;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(30, 29, 76, 0.2);
            margin-bottom: 20px;
            border-top: 4px solid #ff721b;
        }

        h1, h2, h3, h4 {
            font-family: 'ABeeZee', sans-serif;
        }

        h1 {
            color: #1e1d4c;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        h2 {
            color: #1e1d4c;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        h3 {
            color: #1e1d4c;
            margin-bottom: 10px;
        }

        button {
            background: #ff721b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-family: 'ABeeZee', sans-serif;
        }

        button:hover {
            background: #ff924f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 114, 27, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            margin-bottom: 15px;
            transition: border-color 0.3s;
            font-family: 'Libre Baskerville', serif;
        }
        }

        input:focus {
            outline: none;
            border-color: #80b2e8;
        }

        .room-code {
            font-size: 3em;
            font-weight: bold;
            color: #80b2e8;
            font-family: 'ABeeZee', sans-serif;
            text-align: center;
            padding: 30px;
            background: #f0f4ff;
            border-radius: 12px;
            margin: 20px 0;
            letter-spacing: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #80b2e8 0%, #1e1d4c 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .leaderboard {
            margin-top: 20px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            margin: 8px 0;
            background: white;
            border-radius: 8px;
            align-items: center;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid #e0e0e0;
            color: #1e1d4c;
            opacity: 1 !important; /* Force full opacity when not animating */
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
            border-color: #80b2e8;
            box-shadow: 0 2px 8px rgba(128, 178, 232, 0.3);
        }

        .leaderboard-item.top-3 {
            background: linear-gradient(135deg, #ffbc92 0%, #ff924f 100%);
            color: #1e1d4c;
            font-weight: 700;
            border: 3px solid #ff721b;
            box-shadow: 0 4px 12px rgba(255, 114, 27, 0.4);
        }

        .leaderboard-item.animating {
            animation: leaderboardUpdate 0.8s ease-out;
        }

        @keyframes leaderboardUpdate {
            0% {
                transform: translateX(-50px);
                opacity: 0;
            }
            50% {
                transform: translateX(10px);
                opacity: 0.5;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .leaderboard-item.slide-up {
            animation: slideUp 0.6s ease-out;
        }

        .leaderboard-item.slide-down {
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideUp {
            0% {
                transform: translateY(50px);
                opacity: 0.3;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .leaderboard-item.fade-cascade {
            animation: fadeCascade 0.5s ease-out forwards;
            opacity: 0 !important; /* Start invisible during animation */
        }

        @keyframes fadeCascade {
            0% {
                opacity: 0 !important;
                transform: scale(0.8) translateY(20px);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                opacity: 1 !important;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes slideDown {
            0% {
                transform: translateY(-50px);
                opacity: 0.3;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .rank {
            font-size: 1.5em;
            font-weight: bold;
            margin-right: 15px;
            min-width: 40px;
        }

        .player-name {
            flex: 1;
            font-size: 1.1em;
        }

        .player-balance {
            font-size: 1.2em;
            font-weight: bold;
        }

        .insurance-shop {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .insurance-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
            background: white;
        }

        .insurance-card:hover {
            border-color: #80b2e8;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .insurance-card.owned {
            border-color: #28a745;
            background: #f0fff4;
        }

        .insurance-price {
            color: #80b2e8;
            font-size: 1.3em;
            font-weight: bold;
            margin: 10px 0;
        }

        .insurance-coverage {
            color: #666;
            font-size: 0.9em;
            margin: 5px 0;
        }

        .hidden {
            display: none;
        }

        .game-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .display-screen {
            background: #1a1a2e;
            min-height: 100vh;
            color: white;
        }

        .display-header {
            background: linear-gradient(135deg, #80b2e8 0%, #1e1d4c 100%);
            padding: 30px;
            text-align: center;
        }

        .display-header h1 {
            color: white;
            font-size: 3em;
        }

        .display-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 30px;
        }

        .month-indicator {
            text-align: center;
            font-size: 2em;
            color: #80b2e8;
            margin: 20px 0;
            font-weight: bold;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .event-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            z-index: 1000;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .event-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .event-title {
            font-size: 1.8em;
            color: #80b2e8;
            margin-bottom: 15px;
            text-align: center;
        }

        .event-cost {
            font-size: 2.5em;
            font-weight: bold;
            color: #dc3545;
            margin: 20px 0;
            text-align: center;
        }

        .event-cost.covered {
            color: #28a745;
        }

        @media (max-width: 768px) {
            .display-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // ========================================
        // VERSION CHECK - Look for this in console!
        // ========================================
        const GAME_VERSION = "v5.1-FAST-CLAIMS";
        console.log("%c========================================", "color: #ff721b; font-size: 16px; font-weight: bold");
        console.log("%cINSURANCE GAME VERSION: " + GAME_VERSION, "color: #ff721b; font-size: 20px; font-weight: bold");
        console.log("%c========================================", "color: #ff721b; font-size: 16px; font-weight: bold");
        console.log("Features: Tenent branding, Auto-reset, End Game button");

        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyBnA3ABaY2jdDqXPpzOSLmbc_V_BVALkpQ",
            authDomain: "tenent-insurance-game.firebaseapp.com",
            databaseURL: "https://tenent-insurance-game-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "tenent-insurance-game",
            storageBucket: "tenent-insurance-game.firebasestorage.app",
            messagingSenderId: "863690278726",
            appId: "1:863690278726:web:cd05ea67906dbc01000747"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        // Game configuration
        const GAME_CONFIG = {
            startingBalance: 1000,
            monthlyIncome: 200,
            monthsPerGame: 24,
            eventProbability: 0.67, // ~2 out of 3 months
        };

        // Insurance types with multiple tiers
        const INSURANCE_TYPES = {
            // PHONE INSURANCE
            phone_budget: {
                name: "Phone Insurance (Budget)",
                category: "phone",
                monthlyCost: 8,
                covers: ["phone_damage", "theft"],
                deductible: 100,
                brand: "budget",
                claimDifficulty: "hard",
                starRating: 1
            },
            phone_premium: {
                name: "Phone Insurance (Premium)",
                category: "phone",
                monthlyCost: 15,
                covers: ["phone_damage", "theft"],
                deductible: 50,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5
            },

            // CONTENTS INSURANCE
            contents_basic: {
                name: "Contents Insurance (Basic)",
                category: "contents",
                monthlyCost: 12,
                covers: ["burglary", "fire", "water_damage"],
                deductible: 250,
                brand: "budget",
                claimDifficulty: "medium",
                starRating: 3
            },
            contents_standard: {
                name: "Contents Insurance (Standard)",
                category: "contents",
                monthlyCost: 18,
                covers: ["burglary", "fire", "water_damage", "theft"],
                deductible: 150,
                brand: "standard",
                claimDifficulty: "easy",
                starRating: 4
            },
            contents_comprehensive: {
                name: "Contents Insurance (Comprehensive)",
                category: "contents",
                monthlyCost: 25,
                covers: ["burglary", "fire", "water_damage", "theft"],
                deductible: 50,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5
            },

            // CAR INSURANCE
            car_third_party: {
                name: "Car Insurance (Third Party Only)",
                category: "car",
                monthlyCost: 45,
                covers: ["car_liability"],
                deductible: 0,
                brand: "basic",
                claimDifficulty: "hard",
                starRating: 1,
                description: "Only covers damage you cause to others"
            },
            car_tpft: {
                name: "Car Insurance (Third Party, Fire & Theft)",
                category: "car",
                monthlyCost: 65,
                covers: ["car_liability", "car_fire", "car_theft"],
                deductible: 250,
                brand: "standard",
                claimDifficulty: "medium",
                starRating: 3,
                description: "Covers others + if your car is stolen or burns"
            },
            car_comprehensive: {
                name: "Car Insurance (Fully Comprehensive)",
                category: "car",
                monthlyCost: 95,
                covers: ["car_liability", "car_fire", "car_theft", "car_damage"],
                deductible: 200,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5,
                description: "Covers everything including your own car damage"
            },

            // GADGET INSURANCE
            gadget_basic: {
                name: "Gadget Insurance (Basic)",
                category: "gadget",
                monthlyCost: 8,
                covers: ["laptop_damage"],
                deductible: 100,
                brand: "budget",
                claimDifficulty: "hard",
                starRating: 1
            },
            gadget_premium: {
                name: "Gadget Insurance (Premium)",
                category: "gadget",
                monthlyCost: 14,
                covers: ["phone_damage", "laptop_damage", "theft"],
                deductible: 50,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5
            },

            // LIABILITY INSURANCE
            liability_basic: {
                name: "Personal Liability (Basic)",
                category: "liability",
                monthlyCost: 6,
                covers: ["liability"],
                deductible: 100,
                brand: "budget",
                claimDifficulty: "medium",
                starRating: 2
            },
            liability_premium: {
                name: "Personal Liability (Premium)",
                category: "liability",
                monthlyCost: 12,
                covers: ["liability"],
                deductible: 0,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5
            },

            // BICYCLE INSURANCE
            bicycle_budget: {
                name: "Bicycle Insurance (Budget)",
                category: "bicycle",
                monthlyCost: 7,
                covers: ["bike_theft"],
                deductible: 75,
                brand: "budget",
                claimDifficulty: "hard",
                starRating: 1
            },
            bicycle_premium: {
                name: "Bicycle Insurance (Premium)",
                category: "bicycle",
                monthlyCost: 12,
                covers: ["bike_theft", "bike_damage"],
                deductible: 30,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5
            },

            // PET INSURANCE
            pet_accident: {
                name: "Pet Insurance (Accident Only)",
                category: "pet",
                monthlyCost: 10,
                covers: ["pet_emergency"],
                deductible: 200,
                brand: "budget",
                claimDifficulty: "medium",
                starRating: 2,
                description: "Covers injuries only"
            },
            pet_comprehensive: {
                name: "Pet Insurance (Full Cover)",
                category: "pet",
                monthlyCost: 25,
                covers: ["pet_emergency", "pet_liability"],
                deductible: 100,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5,
                description: "Illness + injury + third party liability"
            },

            // TRAVEL INSURANCE
            travel_basic: {
                name: "Travel Insurance (Basic)",
                category: "travel",
                monthlyCost: 8,
                covers: ["travel_issue"],
                deductible: 200,
                brand: "budget",
                claimDifficulty: "hard",
                starRating: 1,
                description: "Medical abroad + cancellation only"
            },
            travel_comprehensive: {
                name: "Travel Insurance (Comprehensive)",
                category: "travel",
                monthlyCost: 15,
                covers: ["travel_issue", "travel_emergency"],
                deductible: 50,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5,
                description: "Everything + gadgets + emergency medical"
            },

            // CYBER/IDENTITY PROTECTION
            cyber_standard: {
                name: "Cyber Protection (Standard)",
                category: "cyber",
                monthlyCost: 4,
                covers: ["cyber_theft"],
                deductible: 100,
                brand: "standard",
                claimDifficulty: "medium",
                starRating: 3,
                description: "Identity theft + fraud monitoring"
            },
            cyber_premium: {
                name: "Cyber Protection (Premium)",
                category: "cyber",
                monthlyCost: 8,
                covers: ["cyber_theft"],
                deductible: 0,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5,
                description: "Full coverage + credit monitoring + recovery"
            }
        };

        // Events database
        const EVENTS = {
            common: [
                { name: "Phone screen cracks", cost: 225, type: "phone_damage", probability: 0.10 },
                { name: "Bike stolen from school", cost: 350, type: "bike_theft", probability: 0.08 },
                { name: "Minor car scratch in car park", cost: 400, type: "car_damage", probability: 0.08 },
                { name: "Laptop charger breaks", cost: 60, type: "gadget", probability: 0.06 },
                { name: "Spilled drink on laptop", cost: 550, type: "laptop_damage", probability: 0.06 },
                { name: "Sports kit bag lost", cost: 120, type: "theft", probability: 0.08 },
                { name: "Glasses broken", cost: 300, type: "personal_items", probability: 0.07 },
                { name: "School bag stolen with belongings", cost: 150, type: "theft", probability: 0.09 },
                { name: "Train ticket fine (forgot railcard)", cost: 80, type: "penalty", probability: 0.07 },
                { name: "Parking fine", cost: 60, type: "penalty", probability: 0.08 },
                { name: "Phone dropped in toilet", cost: 250, type: "phone_damage", probability: 0.08 },
                { name: "Headphones lost", cost: 100, type: "personal_items", probability: 0.07 },
                { name: "Watch broken", cost: 150, type: "personal_items", probability: 0.06 },
                { name: "Library book damaged", cost: 40, type: "penalty", probability: 0.06 }
            ],
            uncommon: [
                { name: "Minor car accident (fender bender)", cost: 1850, type: "car_damage", probability: 0.06 },
                { name: "Water damage ruins electronics", cost: 1050, type: "water_damage", probability: 0.04 },
                { name: "Car break-in, items stolen", cost: 800, type: "theft", probability: 0.04 },
                { name: "Phone stolen on the bus", cost: 650, type: "theft", probability: 0.05 },
                { name: "Accidentally damage friend's property", cost: 550, type: "liability", probability: 0.03 },
                { name: "Accidentally leave tap running, flood bathroom", cost: 2500, type: "water_damage", probability: 0.03 },
                { name: "E-scooter stolen", cost: 800, type: "theft", probability: 0.05 },
                { name: "Identity theft - fraudulent purchases", cost: 1500, type: "cyber_theft", probability: 0.04 },
                { name: "Lost passport, emergency replacement needed", cost: 300, type: "travel_issue", probability: 0.03 },
                { name: "Pet needs emergency vet care", cost: 900, type: "pet_emergency", probability: 0.04 },
                { name: "Storm damages car (tree branch)", cost: 1800, type: "car_damage", probability: 0.03 }
            ],
            rare: [
                { name: "Car written off in accident (your fault)", cost: 16000, type: "car_damage", probability: 0.012 },
                { name: "Car stolen and not recovered", cost: 15000, type: "car_theft", probability: 0.012 },
                { name: "Burglary - flat cleaned out", cost: 19000, type: "burglary", probability: 0.012 },
                { name: "Moderate car accident - damage to multiple vehicles", cost: 12500, type: "car_liability", probability: 0.012 },
                { name: "Fire damages belongings", cost: 16500, type: "fire", probability: 0.008 },
                { name: "Your dog bites someone - sued for damages", cost: 8000, type: "pet_liability", probability: 0.008 },
                { name: "Boiler breakdown, need emergency replacement", cost: 3500, type: "home_emergency", probability: 0.010 }
            ],
            // Major events (£10,000+) - exactly ONE will occur per game
            major: [
                { name: "Flood flat, extensive damage to downstairs neighbor", cost: 35000, type: "liability", probability: 1 },
                { name: "Multi-car accident on motorway - damage to 4 vehicles", cost: 85000, type: "car_liability", probability: 1 },
                { name: "House fire destroys entire home contents", cost: 95000, type: "fire", probability: 1 },
                { name: "Major fire spreads to neighbor's property", cost: 120000, type: "liability", probability: 1 },
                { name: "Cycling accident - someone badly hurt, legal costs", cost: 75000, type: "liability", probability: 1 },
                { name: "Cyber attack - sophisticated identity theft", cost: 25000, type: "cyber_theft", probability: 1 },
                { name: "Emergency medical evacuation from abroad", cost: 80000, type: "travel_emergency", probability: 1 }
            ]
        };

        // BroadcastChannel for cross-tab communication
        const channel = new BroadcastChannel('insurance-game');

        // Game state manager with Firebase - Single global game
        class GameStateManager {
            constructor(roomCode = 'default') {
                this.roomCode = roomCode;
                this.gameRef = database.ref(`rooms/${roomCode}`); // Separate room per code
                this.game = {
                    players: {},
                    started: false,
                    currentMonth: 0,
                    paused: false,
                    finished: false,
                    recentDisplayEvents: [],
                    eventHistory: [],
                    roomCode: roomCode
                };
            }

            save() {
                // Save to Firebase
                this.gameRef.set(this.game);
            }

            // Watch the game for real-time updates
            watchGame(callback) {
                this.gameRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        this.game = data;
                        callback();
                    }
                });
                
                return () => this.gameRef.off();
            }

            initGame() {
                // Initialize or load existing game
                return this.gameRef.once('value').then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        this.game = data;
                        
                        // Clean up any corrupted player data
                        if (this.game.players) {
                            Object.values(this.game.players).forEach(player => {
                                if (!player.insurance) player.insurance = {};
                                if (!player.events) player.events = [];
                                if (!player.pendingClaims) player.pendingClaims = [];
                            });
                        }
                    } else {
                        // Create new game if doesn't exist
                        this.game = {
                            players: {},
                            started: false,
                            currentMonth: 0,
                            paused: false,
                            finished: false,
                            recentDisplayEvents: [],
                            eventHistory: []
                        };
                        this.save();
                    }
                });
            }

            resetGame() {
                console.log('Resetting game...');
                // Teacher can reset the game
                this.game = {
                    players: {},
                    started: false,
                    currentMonth: 0,
                    paused: false,
                    finished: false,
                    recentDisplayEvents: [],
                    eventHistory: []
                };
                console.log('Game reset, saving to Firebase...');
                this.save();
                console.log('Reset complete');
            }

            buyInsurance(playerId, insuranceType) {
                console.log('buyInsurance called:', playerId, insuranceType);
                const player = this.game.players[playerId];
                if (!player) {
                    console.error('Player not found:', playerId);
                    return false;
                }
                
                // Ensure insurance object exists
                if (!player.insurance) {
                    player.insurance = {};
                }
                
                if (player.insurance[insuranceType]) {
                    console.log('Already owns this insurance');
                    return false;
                }

                // Check if player already has insurance in this category
                const newInsurance = INSURANCE_TYPES[insuranceType];
                for (const [ownedType, ownedInsurance] of Object.entries(INSURANCE_TYPES)) {
                    if (player.insurance[ownedType] && ownedInsurance.category === newInsurance.category) {
                        // Cancel existing insurance in same category
                        console.log('Replacing existing insurance:', ownedType);
                        delete player.insurance[ownedType];
                    }
                }

                player.insurance[insuranceType] = true;
                console.log('Insurance purchased, saving...');
                this.save();
                return true;
            }

            cancelInsurance(playerId, insuranceType) {
                const player = this.game.players[playerId];
                if (!player) return false;

                if (!player.insurance) {
                    player.insurance = {};
                }

                delete player.insurance[insuranceType];
                this.save();
                return true;
            }

            advanceClaimStep(playerId, eventId) {
                const player = this.game.players[playerId];
                if (!player) return false;

                if (!player.pendingClaims) {
                    player.pendingClaims = [];
                }

                const claim = player.pendingClaims.find(c => c.eventId === eventId);
                if (!claim) return false;

                // Check if currently waiting for timer
                if (claim.waitingUntil && Date.now() < claim.waitingUntil) {
                    return { waiting: true, remainingSeconds: Math.ceil((claim.waitingUntil - Date.now()) / 1000) };
                }

                // Check if step can fail
                const currentStepData = claim.steps[claim.currentStep];
                if (currentStepData.canFail && Math.random() < currentStepData.failChance) {
                    // Step failed - user must repeat this step
                    claim.failMessage = currentStepData.failMessage;
                    claim.waitingUntil = Date.now() + (currentStepData.duration * 1000);
                    claim.stepAttempts = (claim.stepAttempts || 0) + 1;
                    this.save();
                    return { failed: true, message: currentStepData.failMessage, waitSeconds: currentStepData.duration };
                }

                // Step succeeded - set timer for this step
                claim.failMessage = null;
                claim.waitingUntil = Date.now() + (currentStepData.duration * 1000);
                claim.currentStep++;
                
                if (claim.currentStep >= claim.steps.length) {
                    claim.completed = true;
                    claim.completedAt = Date.now();
                    // Refund the amount (minus deductible)
                    player.balance += claim.refundAmount;
                }

                this.save();
                return { success: true, waitSeconds: currentStepData.duration };
            }

            joinGame(playerName) {
                console.log('joinGame called with:', playerName);
                console.log('Current game state:', this.game);
                
                // Ensure game and players object exists
                if (!this.game) {
                    console.error('Game is undefined! Initializing...');
                    this.game = {
                        players: {},
                        started: false,
                        currentMonth: 0,
                        paused: false,
                        finished: false,
                        recentDisplayEvents: [],
                        eventHistory: []
                    };
                }
                
                if (!this.game.players) {
                    console.log('Players object missing, creating...');
                    this.game.players = {};
                }
                
                const playerId = Math.random().toString(36).substring(2, 15);
                this.game.players[playerId] = {
                    id: playerId,
                    name: playerName,
                    balance: GAME_CONFIG.startingBalance,
                    insurance: {},  // Initialize as empty object
                    events: [],     // Initialize as empty array
                    pendingClaims: []  // Initialize as empty array
                };
                console.log('Player added:', this.game.players[playerId]);
                console.log('Player added, saving to Firebase...');
                this.save();
                console.log('Save called, returning playerId:', playerId);
                return playerId;
            }

            startGame() {
                console.log('startGame called, resetting game state but keeping players...');
                
                // Keep existing players but reset their state
                const existingPlayers = this.game.players || {};
                
                // Reset each player's state
                Object.values(existingPlayers).forEach(player => {
                    player.balance = GAME_CONFIG.startingBalance;
                    player.insurance = {};
                    player.events = [];
                    player.pendingClaims = [];
                });
                
                // Reset game state but keep players
                this.game = {
                    players: existingPlayers,
                    started: true,
                    currentMonth: 1,
                    paused: false,
                    recentDisplayEvents: [],
                    eventHistory: []
                };
                
                console.log('Game started with', Object.keys(existingPlayers).length, 'players');
                this.save();
            }

            selectRandomEvent() {
                const allEvents = [
                    ...EVENTS.common,
                    ...EVENTS.uncommon,
                    ...EVENTS.rare
                    // Note: major events are NOT included here - they're triggered separately
                ];

                const totalProbability = allEvents.reduce((sum, e) => sum + e.probability, 0);
                let random = Math.random() * totalProbability;

                for (const event of allEvents) {
                    random -= event.probability;
                    if (random <= 0) return event;
                }

                return allEvents[0];
            }

            applyEvent(player, event) {
                // Ensure player has all required properties
                if (!player.insurance) player.insurance = {};
                if (!player.events) player.events = [];
                if (!player.pendingClaims) player.pendingClaims = [];
                
                const eventCopy = { ...event, timestamp: Date.now(), id: Math.random().toString(36).substring(2, 15) };
                let actualCost = event.cost;
                let covered = false;
                let insuranceUsed = null;

                if (event.cost > 0) {
                    for (const [insuranceType, insurance] of Object.entries(INSURANCE_TYPES)) {
                        if (player.insurance[insuranceType] && insurance.covers.includes(event.type)) {
                            covered = true;
                            insuranceUsed = insuranceType;
                            actualCost = insurance.deductible;
                            
                            // If not premium insurance, create a claim process
                            if (insurance.claimDifficulty !== 'easy') {
                                const claimSteps = this.generateClaimSteps(insurance.claimDifficulty);
                                player.pendingClaims.push({
                                    eventId: eventCopy.id,
                                    insuranceType: insuranceType,
                                    difficulty: insurance.claimDifficulty,
                                    steps: claimSteps,
                                    currentStep: 0,
                                    completed: false,
                                    refundAmount: event.cost - insurance.deductible
                                });
                            }
                            break;
                        }
                    }
                }

                eventCopy.actualCost = actualCost;
                eventCopy.covered = covered;
                eventCopy.insuranceUsed = insuranceUsed;
                eventCopy.needsClaim = covered && INSURANCE_TYPES[insuranceUsed]?.claimDifficulty !== 'easy';
                player.balance -= actualCost;
                player.events.push(eventCopy);
            }

            generateClaimSteps(difficulty) {
                // 5-star rating (easy) - instant payout
                const easySteps = [
                    { text: "Submit claim form online", duration: 10, canFail: false },
                    { text: "Claim approved!", duration: 10, canFail: false }
                ];
                
                // 2-4 star rating (medium) - standard process
                const mediumSteps = [
                    { text: "Fill out claim form", duration: 15, canFail: false },
                    { text: "Submit proof of purchase", duration: 15, canFail: true, failChance: 0.25, failMessage: "Document rejected - please resubmit" },
                    { text: "Wait for claim review (2-3 days)", duration: 20, canFail: false },
                    { text: "Claim approved!", duration: 10, canFail: false }
                ];
                
                // 1-star rating (hard) - slow, error-prone process
                const hardSteps = [
                    { text: "Call claims hotline (20 min wait)", duration: 20, canFail: false },
                    { text: "Fill out lengthy claim form", duration: 20, canFail: false },
                    { text: "Submit proof of purchase", duration: 20, canFail: true, failChance: 0.4, failMessage: "Insurer says they have lost your documentation - please resubmit" },
                    { text: "Submit additional documentation", duration: 20, canFail: true, failChance: 0.35, failMessage: "Wrong format - please resubmit" },
                    { text: "Wait for assessor visit", duration: 20, canFail: false },
                    { text: "Wait for claim review (5-7 days)", duration: 20, canFail: false },
                    { text: "Respond to request for more information", duration: 20, canFail: true, failChance: 0.3, failMessage: "Insurer says they have lost your documentation - go back to previous step" },
                    { text: "Wait for final review", duration: 20, canFail: false },
                    { text: "Claim approved!", duration: 10, canFail: false }
                ];

                switch(difficulty) {
                    case 'easy': return easySteps;
                    case 'medium': return mediumSteps;
                    case 'hard': return hardSteps;
                    default: return mediumSteps;
                }
            }


            advanceMonth() {
                if (!this.game.started) return;

                // Clear previous display events
                this.game.recentDisplayEvents = [];

                // Select event - first month is ALWAYS cracked phone screen
                let sharedEvent = null;
                if (this.game.currentMonth === 1) {
                    // First event is always cracked phone screen
                    sharedEvent = { 
                        name: "Phone screen cracked", 
                        cost: 250, 
                        type: "phone_damage", 
                        probability: 1.0 
                    };
                } else {
                    // Check if we should trigger the major event this month
                    if (!this.game.majorEventTriggered) {
                        // Pick a random month between 8-20 to trigger major event
                        if (!this.game.majorEventMonth) {
                            this.game.majorEventMonth = Math.floor(Math.random() * 13) + 8; // Month 8-20
                        }
                        
                        if (this.game.currentMonth === this.game.majorEventMonth) {
                            // MAJOR EVENT!
                            const majorEvents = EVENTS.major;
                            sharedEvent = majorEvents[Math.floor(Math.random() * majorEvents.length)];
                            this.game.majorEventTriggered = true;
                        }
                    }
                    
                    // If no major event, do normal event logic
                    if (!sharedEvent && Math.random() < GAME_CONFIG.eventProbability) {
                        sharedEvent = this.selectRandomEvent();
                    }
                }

                Object.values(this.game.players).forEach(player => {
                    player.balance += GAME_CONFIG.monthlyIncome;

                    // Deduct insurance costs
                    if (player.insurance) {
                        Object.keys(player.insurance).forEach(insuranceType => {
                            player.balance -= INSURANCE_TYPES[insuranceType].monthlyCost;
                        });
                    }

                    // Apply the shared event to all players
                    if (sharedEvent) {
                        this.applyEvent(player, sharedEvent);
                        
                        // Add to display events
                        const latestEvent = player.events[player.events.length - 1];
                        this.game.recentDisplayEvents.push({
                            ...latestEvent,
                            playerName: player.name,
                            playerId: player.id
                        });
                    }
                });

                // Store the shared event for display
                this.game.lastSharedEvent = sharedEvent;

                // Add to event history if there was an event
                if (sharedEvent) {
                    if (!this.game.eventHistory) this.game.eventHistory = [];
                    this.game.eventHistory.unshift({
                        month: this.game.currentMonth,
                        name: sharedEvent.name,
                        cost: sharedEvent.cost,
                        type: sharedEvent.type,
                        isMajor: sharedEvent.cost >= 10000
                    });
                    // Keep only last 10 events
                    if (this.game.eventHistory.length > 10) {
                        this.game.eventHistory = this.game.eventHistory.slice(0, 10);
                    }
                }

                this.game.currentMonth++;
                
                if (this.game.currentMonth > GAME_CONFIG.monthsPerGame) {
                    this.game.started = false;
                    this.game.finished = true; // Mark game as finished
                }

                this.save();
            }
        }

        // gameManager is now created per room in the App component

        // NOTE: This version uses localStorage + polling for same-device testing
        // For multi-device classroom use, you need Firebase version
        // See FIREBASE_SETUP_INSTRUCTIONS.md

        // Insurance information for help popups
        const INSURANCE_INFO = {
            phone: {
                title: "Phone Insurance",
                whatItCovers: "Protects your mobile phone from accidental damage, theft, and loss",
                potentialCosts: [
                    { event: "Phone screen cracks", cost: "£225" },
                    { event: "Phone dropped in toilet", cost: "£250" },
                    { event: "Phone stolen on the bus", cost: "£650" },
                    { event: "School bag stolen (with phone)", cost: "£150+" }
                ],
                whyYouNeedIt: "Phones are expensive to replace and easy to damage or lose. Without insurance, you'll pay the full replacement cost.",
                budgetVsPremium: "Budget: Cheaper monthly but long, frustrating claims process with potential for lost paperwork. Premium: More expensive but instant claims and lower excess."
            },
            contents: {
                title: "Contents Insurance",
                whatItCovers: "Protects your belongings in your home/flat from theft, fire, and water damage",
                potentialCosts: [
                    { event: "Burglary - flat cleaned out", cost: "£19,000" },
                    { event: "Fire damages belongings", cost: "£16,500" },
                    { event: "Water damage ruins electronics", cost: "£1,050" },
                    { event: "Flood bathroom damages items", cost: "£2,500" }
                ],
                whyYouNeedIt: "Your belongings (laptop, clothes, furniture, etc.) add up to thousands of pounds. One fire or burglary could wipe out everything.",
                budgetVsPremium: "Basic: Lower monthly cost but higher excess and some items not covered. Comprehensive: Covers almost everything with lower excess and faster claims."
            },
            car: {
                title: "Car Insurance",
                whatItCovers: "Protects you from costs related to car accidents, theft, and damage",
                potentialCosts: [
                    { event: "Minor car accident (fender bender)", cost: "£1,850" },
                    { event: "Car written off (your fault)", cost: "£16,000" },
                    { event: "Car stolen and not recovered", cost: "£15,000" },
                    { event: "Storm damages car", cost: "£1,800" },
                    { event: "Multi-car accident - damage to 4 vehicles", cost: "£85,000" }
                ],
                whyYouNeedIt: "Car accidents can cost tens of thousands - or even hundreds of thousands if you damage multiple vehicles. Third Party Only is legally required but won't fix YOUR car.",
                budgetVsPremium: "Third Party Only: Legally required minimum, only covers damage to OTHERS. TP Fire & Theft: Adds theft and fire protection for your car. Fully Comprehensive: Covers everything including damage to your own car."
            },
            gadget: {
                title: "Gadget Insurance",
                whatItCovers: "Protects laptops, tablets, and electronics from damage and theft",
                potentialCosts: [
                    { event: "Spilled drink on laptop", cost: "£550" },
                    { event: "Laptop charger breaks", cost: "£60" },
                    { event: "Water damage ruins electronics", cost: "£1,050" },
                    { event: "School bag stolen with laptop", cost: "£150+" }
                ],
                whyYouNeedIt: "Laptops and tablets are essential for school/work. One accident could leave you unable to study or work.",
                budgetVsPremium: "Basic: Only covers laptop damage. Premium: Covers all gadgets including phones, plus theft protection."
            },
            liability: {
                title: "Personal Liability Insurance",
                whatItCovers: "Protects you if you accidentally damage someone's property or cause an accident",
                potentialCosts: [
                    { event: "Accidentally damage friend's property", cost: "£550" },
                    { event: "Flood damages downstairs neighbor", cost: "£10,000" },
                    { event: "Cycling accident - damage to vehicles/property", cost: "£75,000" },
                    { event: "Major fire spreads to neighbors", cost: "£120,000" }
                ],
                whyYouNeedIt: "If you accidentally damage someone's property or cause an accident, you could be sued for massive amounts. This protects you from financial ruin.",
                budgetVsPremium: "Basic: Covers most accidents with £100 excess. Premium: No excess and covers larger claims with easier process."
            },
            bicycle: {
                title: "Bicycle Insurance",
                whatItCovers: "Protects your bicycle from theft and damage",
                potentialCosts: [
                    { event: "Bike stolen from school", cost: "£350" }
                ],
                whyYouNeedIt: "Bikes are frequently stolen, especially from schools and public places. A good bike can cost hundreds to replace.",
                budgetVsPremium: "Budget: Only covers theft with higher excess. Premium: Covers theft AND damage (accidents) with lower excess."
            },
            pet: {
                title: "Pet Insurance",
                whatItCovers: "Covers veterinary bills and liability if your pet causes damage or injury",
                potentialCosts: [
                    { event: "Pet needs emergency vet care", cost: "£900" },
                    { event: "Your dog bites someone - sued", cost: "£8,000" }
                ],
                whyYouNeedIt: "Vet bills can be shockingly expensive, and you could be sued if your pet injures someone or damages property.",
                budgetVsPremium: "Accident Only: Cheaper but only covers injuries. Full Cover: Covers illness, injury, AND third party liability if your dog bites someone."
            },
            travel: {
                title: "Travel Insurance",
                whatItCovers: "Protects you from medical emergencies abroad, trip cancellations, and lost belongings",
                potentialCosts: [
                    { event: "Lost passport, emergency replacement", cost: "£300" },
                    { event: "Emergency medical evacuation from abroad", cost: "£80,000" }
                ],
                whyYouNeedIt: "Medical treatment abroad (especially outside Europe) can be extremely expensive. An emergency medical evacuation can cost £80,000+.",
                budgetVsPremium: "Basic: Covers medical emergencies and cancellation only. Comprehensive: Adds gadget cover, extreme sports, and emergency medical evacuation."
            },
            cyber: {
                title: "Cyber/Identity Protection",
                whatItCovers: "Protects you from identity theft, fraud, and cyber attacks",
                potentialCosts: [
                    { event: "Identity theft - fraudulent purchases", cost: "£1,500" },
                    { event: "Cyber attack - bank account drained", cost: "£25,000" }
                ],
                whyYouNeedIt: "Cyber criminals can steal your identity and drain your accounts. Recovery can be expensive and time-consuming.",
                budgetVsPremium: "Standard: Covers fraud with monitoring. Premium: No excess, includes credit monitoring and full recovery service."
            }
        };

        // Helper function to render star rating
        function renderStars(rating) {
            const stars = [];
            for (let i = 1; i <= 5; i++) {
                stars.push(i <= rating ? '⭐' : '☆');
            }
            return stars.join('');
        }

        // Main App Component
        function App() {
            const [view, setView] = useState('home');
            const [playerId, setPlayerId] = useState(null);
            const [playerName, setPlayerName] = useState(null);
            const [gameState, setGameState] = useState(null);
            const [loading, setLoading] = useState(true);
            const [roomCode, setRoomCode] = useState(null);
            const [roomInput, setRoomInput] = useState('');

            // Get room code from URL or show room selection
            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const urlRoom = urlParams.get('room');
                if (urlRoom) {
                    setRoomCode(urlRoom.toUpperCase());
                }
            }, []);

            useEffect(() => {
                if (!roomCode) return; // Wait for room code
                
                // Initialize and watch the game
                console.log('App: Initializing game for room:', roomCode);
                
                // Create game manager for this room
                window.gameManager = new GameStateManager(roomCode);
                
                window.gameManager.initGame().then(() => {
                    console.log('App: Game initialized:', window.gameManager.game);
                    setGameState({...window.gameManager.game});
                    setLoading(false);
                    
                    // Now start watching for updates
                    console.log('App: Starting Firebase listener...');
                    const unsubscribe = window.gameManager.watchGame(() => {
                        console.log('App: Game updated from Firebase');
                        setGameState({...window.gameManager.game});
                    });
                    
                    return unsubscribe;
                }).catch((error) => {
                    console.error('App: Failed to initialize game:', error);
                    setLoading(false);
                });
            }, [roomCode]);

            // Room selection screen
            if (!roomCode) {
                return (
                    <div className="container">
                        <div className="card" style={{ marginTop: '50px', maxWidth: '500px', margin: '50px auto' }}>
                            <h1 style={{ textAlign: 'center', color: '#1e1d4c' }}>🏫 Insurance Game</h1>
                            <h2 style={{ textAlign: 'center', marginBottom: '30px' }}>Enter Room Code</h2>
                            
                            <div style={{ marginBottom: '20px' }}>
                                <input
                                    type="text"
                                    placeholder="Enter room code (e.g., YEAR10A)"
                                    value={roomInput}
                                    onChange={(e) => setRoomInput(e.target.value.toUpperCase())}
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter' && roomInput.trim()) {
                                            setRoomCode(roomInput.trim());
                                        }
                                    }}
                                    style={{
                                        width: '100%',
                                        padding: '15px',
                                        fontSize: '1.2em',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '8px',
                                        textAlign: 'center',
                                        textTransform: 'uppercase'
                                    }}
                                />
                            </div>
                            
                            <button
                                onClick={() => {
                                    if (roomInput.trim()) {
                                        setRoomCode(roomInput.trim());
                                    }
                                }}
                                disabled={!roomInput.trim()}
                                style={{
                                    width: '100%',
                                    padding: '15px',
                                    fontSize: '1.1em',
                                    background: roomInput.trim() ? '#ff721b' : '#ccc',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '8px',
                                    cursor: roomInput.trim() ? 'pointer' : 'not-allowed',
                                    fontWeight: 'bold'
                                }}
                            >
                                Join Room
                            </button>
                            
                            <div style={{ 
                                marginTop: '30px', 
                                padding: '20px', 
                                background: '#f8f9fa', 
                                borderRadius: '8px',
                                fontSize: '0.9em',
                                color: '#666'
                            }}>
                                <strong>Teachers:</strong> Create a room code for your class (e.g., YEAR10A, CLASS1, etc.)
                                <br/><br/>
                                <strong>Students:</strong> Enter the room code your teacher gave you
                            </div>
                        </div>
                    </div>
                );
            }

            if (loading) {
                return (
                    <div className="container">
                        <div className="card" style={{ marginTop: '50px', textAlign: 'center' }}>
                            <h2>Loading Room: {roomCode}</h2>
                            <p>Connecting to Firebase...</p>
                        </div>
                    </div>
                );
            }

            const handleTeacherView = () => {
                setView('display');
            };

            const handleJoinGame = (name) => {
                console.log('Joining game with name:', name);
                const id = window.gameManager.joinGame(name);
                console.log('Got player ID:', id);
                console.log('Game state after join:', window.gameManager.game);
                setPlayerId(id);
                setPlayerName(name);
                setGameState({...window.gameManager.game});
                setView('player');
            };

            if (view === 'home') {
                return <HomeScreen onTeacherView={handleTeacherView} onStudentView={() => setView('join')} roomCode={roomCode} />;
            } else if (view === 'join') {
                return <JoinScreen onJoin={handleJoinGame} onBack={() => setView('home')} />;
            } else if (view === 'player') {
                return <PlayerScreen 
                    playerId={playerId} 
                    playerName={playerName} 
                    gameState={gameState}
                    onUpdate={() => setGameState({...window.gameManager.game})}
                />;
            } else if (view === 'display') {
                return <DisplayScreen 
                    gameState={gameState} 
                    onBack={() => setView('home')}
                    onUpdate={() => setGameState({...window.gameManager.game})}
                />;
            }
        }

        function HomeScreen({ onTeacherView, onStudentView, roomCode }) {
            const logoBase64 = "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";
            return (
                <div className="container">
                    <div className="card" style={{ marginTop: '50px', textAlign: 'center' }}>
                        <div style={{ 
                            background: '#ff721b', 
                            color: 'white', 
                            padding: '10px', 
                            borderRadius: '8px 8px 0 0',
                            marginTop: '-20px',
                            marginBottom: '20px',
                            marginLeft: '-20px',
                            marginRight: '-20px'
                        }}>
                            <strong>Room Code: {roomCode}</strong>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: '20px' }}>
                            <img src={`data:image/png;base64,${logoBase64}`} alt="Tenent Logo" style={{ height: '80px', marginRight: '15px' }} />
                            <h1 style={{ margin: 0 }}>Life Happens: Understanding Insurance</h1>
                        </div>
                        <p style={{ fontSize: '1.2em', margin: '20px 0', color: '#1e1d4c' }}>
                            Learn how insurance works through real-life scenarios
                        </p>
                        <div style={{ marginTop: '40px' }}>
                            <button style={{ margin: '10px', width: '200px' }} onClick={onTeacherView}>
                                🎮 Teacher View (Display)
                            </button>
                            <button style={{ margin: '10px', width: '200px' }} onClick={onStudentView}>
                                👤 Join Game (Student)
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function JoinScreen({ onJoin, onBack }) {
            const [name, setName] = useState('');

            return (
                <div className="container">
                    <div className="card" style={{ marginTop: '50px' }}>
                        <h2>Join Game</h2>
                        <div>
                            <label>Your Name:</label>
                            <input type="text" placeholder="Enter your name" value={name} onChange={(e) => setName(e.target.value)} />
                        </div>
                        <button onClick={() => {
                            const trimmedName = name.trim();
                            if (!trimmedName) {
                                alert('Please enter your name');
                                return;
                            }
                            onJoin(trimmedName);
                        }}>Join Game</button>
                        <button className="btn-secondary" style={{ marginLeft: '10px' }} onClick={onBack}>Back</button>
                    </div>
                </div>
            );
        }

        function DisplayJoinScreen({ onJoin, onBack }) {
            const [code, setCode] = useState('');

            return (
                <div className="container">
                    <div className="card" style={{ marginTop: '50px' }}>
                        <h2>Display Screen</h2>
                        <div>
                            <label>Room Code:</label>
                            <input 
                                type="text" 
                                placeholder="Enter room code" 
                                value={code} 
                                onChange={(e) => setCode(e.target.value.toUpperCase())}
                                style={{ textTransform: 'uppercase' }}
                            />
                        </div>
                        <button onClick={() => {
                            const trimmedCode = code.trim();
                            // Load room from Firebase before joining
                            database.ref('rooms/' + trimmedCode).once('value').then((snapshot) => {
                                const roomData = snapshot.val();
                                if (roomData) {
                                    window.gameManager.rooms[trimmedCode] = roomData;
                                    onJoin(trimmedCode);
                                } else {
                                    alert('Room not found');
                                }
                            });
                        }}>Load Display</button>
                        <button className="btn-secondary" style={{ marginLeft: '10px' }} onClick={onBack}>Back</button>
                    </div>
                </div>
            );
        }

        function PlayerScreen({ playerId, playerName, gameState, onUpdate }) {
            const [showEventPopup, setShowEventPopup] = useState(false);
            const [currentEvent, setCurrentEvent] = useState(null);
            const [claimTimers, setClaimTimers] = useState({});
            const [claimMessages, setClaimMessages] = useState({});
            const [showInsuranceInfo, setShowInsuranceInfo] = useState(null);

            const game = gameState;
            if (!game) {
                return (
                    <div className="container">
                        <div className="card">
                            <h2>Loading game data...</h2>
                            <p>Waiting for game to initialize...</p>
                        </div>
                    </div>
                );
            }
            
            if (!game.players) {
                game.players = {};
            }

            const player = game.players[playerId];
            if (!player) {
                return (
                    <div className="container">
                        <div className="card">
                            <h2>Player not found</h2>
                            <p>Your player data is loading...</p>
                            <button onClick={onUpdate}>Refresh</button>
                        </div>
                    </div>
                );
            }

            // Check for new events and show popup
            useEffect(() => {
                if (player.events && player.events.length > 0) {
                    const latestEvent = player.events[player.events.length - 1];
                    const eventAge = Date.now() - latestEvent.timestamp;
                    
                    // Show popup if event is less than 5 seconds old
                    if (eventAge < 5000 && !showEventPopup) {
                        setCurrentEvent(latestEvent);
                        setShowEventPopup(true);
                    }
                }
            }, [player.events]);

            // Update timers for claims
            useEffect(() => {
                const interval = setInterval(() => {
                    if (player.pendingClaims) {
                        const newTimers = {};
                        player.pendingClaims.forEach(claim => {
                            if (claim.waitingUntil) {
                                const remaining = Math.max(0, Math.ceil((claim.waitingUntil - Date.now()) / 1000));
                                newTimers[claim.eventId] = remaining;
                            }
                        });
                        setClaimTimers(newTimers);
                    }
                }, 1000);

                return () => clearInterval(interval);
            }, [player.pendingClaims]);

            const handleClaimStep = (eventId) => {
                const result = window.gameManager.advanceClaimStep(playerId, eventId);
                
                if (result.waiting) {
                    setClaimMessages(prev => ({
                        ...prev,
                        [eventId]: { type: 'wait', text: `Please wait ${result.remainingSeconds} seconds...` }
                    }));
                } else if (result.failed) {
                    setClaimMessages(prev => ({
                        ...prev,
                        [eventId]: { type: 'error', text: `❌ ${result.message}` }
                    }));
                    setTimeout(() => {
                        setClaimMessages(prev => ({ ...prev, [eventId]: null }));
                    }, 3000);
                } else if (result.success) {
                    setClaimMessages(prev => ({
                        ...prev,
                        [eventId]: { type: 'success', text: `⏱️ Processing... (${result.waitSeconds}s)` }
                    }));
                    setTimeout(() => {
                        setClaimMessages(prev => ({ ...prev, [eventId]: null }));
                    }, 3000);
                }
                
                onUpdate();
            };

            const insuranceCost = player.insurance ? Object.keys(player.insurance).reduce((sum, type) => {
                console.log('Calculating cost for type:', type, 'INSURANCE_TYPES:', INSURANCE_TYPES);
                const insurance = INSURANCE_TYPES[type];
                if (!insurance) {
                    console.error('Insurance type not found:', type);
                    return sum;
                }
                return sum + insurance.monthlyCost;
            }, 0) : 0;

            return (
                <div className="container">
                    {/* Insurance Information Popup */}
                    {showInsuranceInfo && INSURANCE_INFO[showInsuranceInfo] && (
                        <>
                            <div className="event-overlay" onClick={() => setShowInsuranceInfo(null)}></div>
                            <div className="event-popup" style={{ maxWidth: '600px' }}>
                                <div className="event-title" style={{ fontSize: '2em' }}>
                                    {INSURANCE_INFO[showInsuranceInfo].title}
                                </div>
                                
                                <div style={{ textAlign: 'left', marginTop: '20px' }}>
                                    <h3 style={{ color: '#80b2e8', marginBottom: '10px' }}>What It Covers:</h3>
                                    <p style={{ marginBottom: '20px', lineHeight: '1.6' }}>
                                        {INSURANCE_INFO[showInsuranceInfo].whatItCovers}
                                    </p>

                                    <h3 style={{ color: '#80b2e8', marginBottom: '10px' }}>Potential Costs Without Insurance:</h3>
                                    <div style={{ 
                                        background: '#fff3e0', 
                                        padding: '15px', 
                                        borderRadius: '8px',
                                        marginBottom: '20px',
                                        border: '2px solid #ff9800'
                                    }}>
                                        {INSURANCE_INFO[showInsuranceInfo].potentialCosts.map((item, i) => (
                                            <div key={i} style={{ 
                                                display: 'flex', 
                                                justifyContent: 'space-between',
                                                marginBottom: '8px',
                                                paddingBottom: '8px',
                                                borderBottom: i < INSURANCE_INFO[showInsuranceInfo].potentialCosts.length - 1 ? '1px solid #ffe0b2' : 'none'
                                            }}>
                                                <span>{item.event}</span>
                                                <strong style={{ color: '#dc3545' }}>{item.cost}</strong>
                                            </div>
                                        ))}
                                    </div>

                                    <h3 style={{ color: '#80b2e8', marginBottom: '10px' }}>Why You Need It:</h3>
                                    <p style={{ marginBottom: '20px', lineHeight: '1.6' }}>
                                        {INSURANCE_INFO[showInsuranceInfo].whyYouNeedIt}
                                    </p>

                                    <h3 style={{ color: '#80b2e8', marginBottom: '10px' }}>Choosing Your Policy:</h3>
                                    <p style={{ marginBottom: '20px', lineHeight: '1.6', fontSize: '0.95em' }}>
                                        {INSURANCE_INFO[showInsuranceInfo].budgetVsPremium}
                                    </p>
                                </div>

                                <button 
                                    style={{ marginTop: '10px', width: '100%' }}
                                    onClick={() => setShowInsuranceInfo(null)}
                                >
                                    Close
                                </button>
                            </div>
                        </>
                    )}

                    {/* Event Popup */}
                    {showEventPopup && currentEvent && (
                        <>
                            <div className="event-overlay" onClick={() => setShowEventPopup(false)}></div>
                            <div className="event-popup">
                                <div className="event-title">
                                    {currentEvent.cost > 0 ? '⚠️ Event Occurred!' : '⚠️ Event Occurred!'}
                                </div>
                                <h3 style={{ margin: '20px 0', fontSize: '1.5em' }}>{currentEvent.name}</h3>
                                
                                {currentEvent.covered ? (
                                    <div>
                                        <div style={{ fontSize: '1.2em', color: '#666', marginBottom: '10px' }}>
                                            Original Cost: <span style={{ textDecoration: 'line-through' }}>£{currentEvent.cost.toLocaleString()}</span>
                                        </div>
                                        <div className="event-cost covered">
                                            You Pay Now: £{currentEvent.actualCost.toLocaleString()}
                                        </div>
                                            {currentEvent.needsClaim ? (
                                                <div style={{ 
                                                    fontSize: '1em', 
                                                    color: '#ff9800', 
                                                    marginTop: '15px',
                                                    padding: '15px',
                                                    background: '#fff3e0',
                                                    borderRadius: '8px',
                                                    border: '2px solid #ff9800'
                                                }}>
                                                    <strong>⚠️ Claims Process Required</strong>
                                                    <div style={{ marginTop: '8px', fontSize: '0.9em' }}>
                                                        You paid the excess upfront. To get your refund of <strong>£{(currentEvent.cost - currentEvent.actualCost).toLocaleString()}</strong>, you need to complete the claims process.
                                                    </div>
                                                    {currentEvent.insuranceUsed && INSURANCE_TYPES[currentEvent.insuranceUsed] && (
                                                        <div style={{ marginTop: '8px', fontSize: '0.9em' }}>
                                                            Your insurer rating: {renderStars(INSURANCE_TYPES[currentEvent.insuranceUsed].starRating)}
                                                        </div>
                                                    )}
                                                    <div style={{ marginTop: '8px', fontSize: '0.85em', color: '#666' }}>
                                                        Check "Pending Insurance Claims" section below.
                                                    </div>
                                                </div>
                                            ) : (
                                                <div style={{ fontSize: '1.1em', color: '#28a745', marginTop: '10px' }}>
                                                    ✓ {renderStars(5)} Premium Insurance - Claim Paid Instantly!
                                                    <div style={{ fontSize: '0.9em', marginTop: '5px' }}>
                                                        Saved: £{(currentEvent.cost - currentEvent.actualCost).toLocaleString()}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div>
                                            <div className="event-cost">
                                                You Pay: £{currentEvent.actualCost.toLocaleString()}
                                            </div>
                                            <div style={{ fontSize: '1.1em', color: '#dc3545', marginTop: '10px' }}>
                                                ❌ Not covered by insurance
                                            </div>
                                        </div>
                                    )}

                                <button 
                                    style={{ marginTop: '20px', width: '100%' }}
                                    onClick={() => setShowEventPopup(false)}
                                >
                                    OK
                                </button>
                            </div>
                        </>
                    )}
                    <div className="card">
                        <h2>Welcome, {player.name}!</h2>
                        {!game.started && !game.finished && (
                            <div className="game-info">
                                <p>⏳ Waiting for teacher to start the game...</p>
                                <p>Room Code: {game.code}</p>
                            </div>
                        )}
                        {(game.started || game.finished) && (
                            <div>
                                {game.finished ? (
                                    // GAME OVER - Show detailed end screen
                                    <>
                                        <div className="month-indicator">
                                            <span style={{ color: '#4CAF50', fontSize: '1.2em' }}>🏁 GAME OVER</span>
                                        </div>
                                        
                                        {(() => {
                                            // Calculate statistics
                                            const totalInsuranceSpent = (GAME_CONFIG.monthsPerGame * insuranceCost);
                                            const totalLosses = player.events.reduce((sum, e) => sum + e.cost, 0);
                                            const insuredLosses = player.events.filter(e => e.covered).reduce((sum, e) => sum + e.cost, 0);
                                            const uninsuredLosses = totalLosses - insuredLosses;
                                            const insurancePayout = player.events.filter(e => e.covered).reduce((sum, e) => sum + (e.cost - e.actualCost), 0);
                                            
                                            // Calculate ranking
                                            const sortedPlayers = Object.values(game.players).sort((a, b) => b.balance - a.balance);
                                            const playerRank = sortedPlayers.findIndex(p => p.id === playerId) + 1;
                                            const isTopThree = playerRank <= 3;
                                            
                                            return (
                                                <div style={{ 
                                                    background: isTopThree ? 'linear-gradient(135deg, #ffbc92 0%, #ff924f 100%)' : 'white',
                                                    border: isTopThree ? '4px solid #ff721b' : '2px solid #e0e0e0',
                                                    borderRadius: '12px',
                                                    padding: '30px',
                                                    marginTop: '20px',
                                                    boxShadow: isTopThree ? '0 8px 20px rgba(255, 114, 27, 0.4)' : 'none'
                                                }}>
                                                    <h2 style={{ 
                                                        textAlign: 'center', 
                                                        marginBottom: '30px',
                                                        color: '#1e1d4c'
                                                    }}>
                                                        {isTopThree && (
                                                            <div style={{ fontSize: '3em', marginBottom: '10px' }}>
                                                                {playerRank === 1 ? '🥇' : playerRank === 2 ? '🥈' : '🥉'}
                                                            </div>
                                                        )}
                                                        Final Results: {player.name}
                                                        {isTopThree && (
                                                            <div style={{ fontSize: '0.8em', marginTop: '10px', color: '#ff721b' }}>
                                                                Finished #{playerRank}!
                                                            </div>
                                                        )}
                                                    </h2>
                                                    
                                                    <div style={{ 
                                                        display: 'grid', 
                                                        gap: '15px',
                                                        fontSize: '1.1em',
                                                        lineHeight: '1.8'
                                                    }}>
                                                        <div style={{ 
                                                            padding: '15px',
                                                            background: 'rgba(255,255,255,0.5)',
                                                            borderRadius: '8px'
                                                        }}>
                                                            <strong>You started with:</strong>
                                                            <div style={{ fontSize: '1.3em', color: '#1e1d4c', fontWeight: 'bold' }}>
                                                                £{GAME_CONFIG.startingBalance.toLocaleString()}
                                                            </div>
                                                        </div>
                                                        
                                                        <div style={{ 
                                                            padding: '15px',
                                                            background: 'rgba(255,255,255,0.5)',
                                                            borderRadius: '8px'
                                                        }}>
                                                            <strong>You spent on insurance:</strong>
                                                            <div style={{ fontSize: '1.3em', color: '#ff721b', fontWeight: 'bold' }}>
                                                                £{totalInsuranceSpent.toLocaleString()}
                                                            </div>
                                                        </div>
                                                        
                                                        <div style={{ 
                                                            padding: '15px',
                                                            background: 'rgba(255,255,255,0.5)',
                                                            borderRadius: '8px'
                                                        }}>
                                                            <strong>You suffered total losses of:</strong>
                                                            <div style={{ fontSize: '1.3em', color: '#dc3545', fontWeight: 'bold' }}>
                                                                £{totalLosses.toLocaleString()}
                                                            </div>
                                                            <div style={{ fontSize: '0.9em', marginTop: '5px' }}>
                                                                Insured: £{insuredLosses.toLocaleString()} | 
                                                                Uninsured: £{uninsuredLosses.toLocaleString()}
                                                            </div>
                                                        </div>
                                                        
                                                        <div style={{ 
                                                            padding: '15px',
                                                            background: 'rgba(255,255,255,0.5)',
                                                            borderRadius: '8px'
                                                        }}>
                                                            <strong>Insurance paid out:</strong>
                                                            <div style={{ fontSize: '1.3em', color: '#28a745', fontWeight: 'bold' }}>
                                                                £{insurancePayout.toLocaleString()}
                                                            </div>
                                                        </div>
                                                        
                                                        <div style={{ 
                                                            padding: '20px',
                                                            background: '#1e1d4c',
                                                            color: 'white',
                                                            borderRadius: '8px',
                                                            marginTop: '10px'
                                                        }}>
                                                            <strong>Final Balance:</strong>
                                                            <div style={{ fontSize: '2em', fontWeight: 'bold' }}>
                                                                £{player.balance.toLocaleString()}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </>
                                ) : (
                                    // GAME IN PROGRESS
                                    <>
                                        <div className="month-indicator">
                                            <>Month {game.currentMonth} of {GAME_CONFIG.monthsPerGame}</>
                                        </div>
                                        <div className="stats-grid">
                                            <div className="stat-card">
                                                <div className="stat-label">Balance</div>
                                                <div className="stat-value">£{player.balance.toLocaleString()}</div>
                                            </div>
                                            <div className="stat-card">
                                                <div className="stat-label">Monthly Income</div>
                                        <div className="stat-value">£{GAME_CONFIG.monthlyIncome}</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-label">Insurance Cost</div>
                                        <div className="stat-value">£{insuranceCost}</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-label">Policies</div>
                                        <div className="stat-value">{player.insurance ? Object.keys(player.insurance).length : 0}</div>
                                    </div>
                                </div>

                                <h3>🛡️ Insurance Shop</h3>
                                <p style={{ fontSize: '0.9em', color: '#666', marginBottom: '15px' }}>
                                    You can only have one insurance policy per category. Buying a new one will replace your current policy.
                                </p>
                                <div className="insurance-shop">
                                    {Object.entries(
                                        Object.entries(INSURANCE_TYPES).reduce((acc, [type, insurance]) => {
                                            if (!acc[insurance.category]) acc[insurance.category] = [];
                                            acc[insurance.category].push({ type, ...insurance });
                                            return acc;
                                        }, {})
                                    ).map(([category, options]) => (
                                        <div key={category} style={{ 
                                            gridColumn: options.length > 2 ? 'span 2' : 'auto',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '12px',
                                            padding: '15px',
                                            background: '#f8f9fa'
                                        }}>
                                            <h4 style={{ 
                                                textTransform: 'capitalize', 
                                                marginBottom: '15px',
                                                color: '#80b2e8',
                                                fontSize: '1.2em',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'space-between'
                                            }}>
                                                <span>{category} Insurance</span>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setShowInsuranceInfo(category);
                                                    }}
                                                    style={{
                                                        background: '#80b2e8',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '50%',
                                                        width: '28px',
                                                        height: '28px',
                                                        fontSize: '0.9em',
                                                        cursor: 'pointer',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        padding: 0
                                                    }}
                                                    title="Learn more about this insurance"
                                                >
                                                    ℹ️
                                                </button>
                                            </h4>
                                            <div style={{ 
                                                display: 'grid', 
                                                gridTemplateColumns: `repeat(${Math.min(options.length, 3)}, 1fr)`,
                                                gap: '10px'
                                            }}>
                                                {options.map(insurance => (
                                                    <div key={insurance.type} className={`insurance-card ${player.insurance && player.insurance[insurance.type] ? 'owned' : ''}`}>
                                                        <h5 style={{ fontSize: '0.95em', marginBottom: '8px' }}>
                                                            {category === 'car' ? (
                                                                insurance.type === 'car_third_party' ? '🚗 Third Party Only' :
                                                                insurance.type === 'car_tpft' ? '🔥 TP Fire & Theft' :
                                                                '✨ Fully Comprehensive'
                                                            ) : (
                                                                <>
                                                                    {insurance.brand === 'budget' && '💰 '}
                                                                    {insurance.brand === 'basic' && '💰 '}
                                                                    {insurance.brand === 'standard' && '⭐ '}
                                                                    {insurance.brand === 'premium' && '✨ '}
                                                                    {insurance.brand.charAt(0).toUpperCase() + insurance.brand.slice(1)}
                                                                </>
                                                            )}
                                                        </h5>
                                                        <div className="insurance-price">£{insurance.monthlyCost}/mo</div>
                                                        <div className="insurance-coverage">Excess: £{insurance.deductible}</div>
                                                        {insurance.description && (
                                                            <div className="insurance-coverage" style={{ fontSize: '0.75em', fontStyle: 'italic', marginTop: '5px' }}>
                                                                {insurance.description}
                                                            </div>
                                                        )}
                                                        <div className="insurance-coverage" style={{ fontSize: '1.1em', marginTop: '5px' }}>
                                                            Claims: {renderStars(insurance.starRating)}
                                                        </div>
                                                        {!(player.insurance && player.insurance[insurance.type]) ? (
                                                            <button 
                                                                style={{ marginTop: '10px', width: '100%', fontSize: '0.85em', padding: '8px' }}
                                                                onClick={() => {
                                                                    window.gameManager.buyInsurance(playerId, insurance.type);
                                                                    onUpdate();
                                                                }}
                                                            >
                                                                Buy
                                                            </button>
                                                        ) : (
                                                            <button 
                                                                className="btn-danger"
                                                                style={{ marginTop: '10px', width: '100%', fontSize: '0.85em', padding: '8px' }}
                                                                onClick={() => {
                                                                    window.gameManager.cancelInsurance(playerId, insurance.type);
                                                                    onUpdate();
                                                                }}
                                                            >
                                                                ✓ Active
                                                            </button>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {player.pendingClaims && player.pendingClaims.filter(c => !c.completed).length > 0 && (
                                    <div>
                                        <h3>📝 Pending Insurance Claims</h3>
                                        <p style={{ fontSize: '0.9em', color: '#666', marginBottom: '10px' }}>
                                            Complete each step to process your claim. Lower-rated insurers ({renderStars(1)}) require more steps and may lose documentation.
                                        </p>
                                        {player.pendingClaims && player.pendingClaims.filter(c => !c.completed).map((claim, idx) => {
                                            const event = player.events.find(e => e.id === claim.eventId);
                                            const insuranceUsed = INSURANCE_TYPES[event?.insuranceUsed];
                                            const currentStepData = claim.steps[claim.currentStep];
                                            const timeRemaining = claimTimers[claim.eventId] || 0;
                                            const canClick = timeRemaining === 0;
                                            const message = claimMessages[claim.eventId];
                                            
                                            return (
                                                <div key={idx} className="game-info" style={{ marginBottom: '15px' }}>
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '10px' }}>
                                                        <div>
                                                            <strong>{event?.name || 'Claim'}</strong>
                                                            {insuranceUsed && (
                                                                <div style={{ fontSize: '0.85em', color: '#80b2e8', marginTop: '4px' }}>
                                                                    Insurer rating: {renderStars(insuranceUsed.starRating)}
                                                                </div>
                                                            )}
                                                            {claim.stepAttempts > 0 && (
                                                                <span style={{ 
                                                                    display: 'block',
                                                                    marginTop: '4px', 
                                                                    color: '#ff9800', 
                                                                    fontSize: '0.85em' 
                                                                }}>
                                                                    ⚠️ {claim.stepAttempts} failed {claim.stepAttempts === 1 ? 'attempt' : 'attempts'}
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div style={{ textAlign: 'right' }}>
                                                            Refund: <strong style={{ color: '#28a745' }}>£{claim.refundAmount.toLocaleString()}</strong>
                                                        </div>
                                                    </div>
                                                    
                                                    <div style={{ 
                                                        background: '#fff',
                                                        padding: '15px',
                                                        borderRadius: '8px',
                                                        marginTop: '10px'
                                                    }}>
                                                        <div style={{ marginBottom: '10px', fontSize: '0.9em', color: '#666' }}>
                                                            Progress: Step {claim.currentStep + 1} of {claim.steps.length}
                                                        </div>
                                                        <div style={{ 
                                                            background: '#e0e0e0',
                                                            height: '20px',
                                                            borderRadius: '10px',
                                                            overflow: 'hidden',
                                                            marginBottom: '15px'
                                                        }}>
                                                            <div style={{ 
                                                                background: 'linear-gradient(90deg, #80b2e8 0%, #1e1d4c 100%)',
                                                                height: '100%',
                                                                width: `${(claim.currentStep / claim.steps.length) * 100}%`,
                                                                transition: 'width 0.3s'
                                                            }}></div>
                                                        </div>
                                                        
                                                        <div style={{ 
                                                            padding: '12px',
                                                            background: claim.failMessage ? '#fff3cd' : '#f8f9fa',
                                                            borderRadius: '6px',
                                                            marginBottom: '10px',
                                                            fontSize: '0.95em',
                                                            border: claim.failMessage ? '2px solid #ff9800' : 'none'
                                                        }}>
                                                            {currentStepData.text}
                                                            {claim.failMessage && (
                                                                <div style={{ 
                                                                    marginTop: '8px', 
                                                                    color: '#ff9800',
                                                                    fontWeight: 'bold',
                                                                    fontSize: '0.9em'
                                                                }}>
                                                                    {claim.failMessage}
                                                                </div>
                                                            )}
                                                        </div>

                                                        {timeRemaining > 0 && (
                                                            <div style={{ 
                                                                padding: '10px',
                                                                background: '#e3f2fd',
                                                                borderRadius: '6px',
                                                                marginBottom: '10px',
                                                                textAlign: 'center',
                                                                fontSize: '1.1em',
                                                                fontWeight: 'bold',
                                                                color: '#1976d2'
                                                            }}>
                                                                ⏱️ Please wait: {timeRemaining}s
                                                            </div>
                                                        )}

                                                        {message && (
                                                            <div style={{ 
                                                                padding: '10px',
                                                                background: message.type === 'error' ? '#ffebee' : 
                                                                          message.type === 'success' ? '#e8f5e9' : '#fff3e0',
                                                                borderRadius: '6px',
                                                                marginBottom: '10px',
                                                                color: message.type === 'error' ? '#c62828' : 
                                                                       message.type === 'success' ? '#2e7d32' : '#ef6c00',
                                                                fontSize: '0.9em',
                                                                textAlign: 'center'
                                                            }}>
                                                                {message.text}
                                                            </div>
                                                        )}
                                                        
                                                        <button
                                                            onClick={() => handleClaimStep(claim.eventId)}
                                                            style={{ width: '100%' }}
                                                            disabled={!canClick}
                                                        >
                                                            {!canClick ? `⏱️ Wait ${timeRemaining}s` :
                                                             claim.failMessage ? 'Try Again' :
                                                             claim.currentStep === claim.steps.length - 1 ? '✓ Complete Claim' : 
                                                             'Next Step →'}
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}

                                {player.events && player.events.length > 0 && (
                                    <div>
                                        <h3>📋 Recent Events</h3>
                                        <div>
                                            {player.events && player.events.slice(-5).reverse().map((event, i) => (
                                                <div key={i} className="game-info" style={{ marginBottom: '10px' }}>
                                                    <strong>{event.name}</strong><br />
                                                    {event.covered ? (
                                                        <span style={{ color: '#28a745' }}>
                                                            ✓ Covered! You paid £{event.actualCost} (Insurance saved £{event.cost - event.actualCost})
                                                        </span>
                                                    ) : (
                                                        <span style={{ color: '#dc3545' }}>
                                                            You paid £{event.actualCost}
                                                        </span>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                </>
                            )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function DisplayScreen({ gameState, onBack, onUpdate }) {
            const logoBase64 = "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";
            const [showEventPopup, setShowEventPopup] = useState(false);
            const [displayEvents, setDisplayEvents] = useState([]);
            const [previousRankings, setPreviousRankings] = useState({});
            const [animatingLeaderboard, setAnimatingLeaderboard] = useState(false);

            const game = gameState;
            if (!game) {
                return (
                    <div className="container">
                        <div className="card">
                            <h2>Loading game data...</h2>
                            <p>Connecting to Firebase...</p>
                        </div>
                    </div>
                );
            }
            
            if (!game.players) {
                game.players = {};
            }

            // Check for new display events
            useEffect(() => {
                if (game.lastSharedEvent) {
                    setDisplayEvents(game.recentDisplayEvents || []);
                    setShowEventPopup(true);
                    
                    // Auto-close after 15 seconds
                    const timer = setTimeout(() => {
                        setShowEventPopup(false);
                    }, 15000);
                    
                    return () => clearTimeout(timer);
                }
            }, [game.lastSharedEvent, game.currentMonth]);

            const playerCount = Object.keys(game.players).length;
            const sortedPlayers = Object.values(game.players).sort((a, b) => b.balance - a.balance);
            const avgBalance = playerCount > 0 ? Math.round(sortedPlayers.reduce((sum, p) => sum + p.balance, 0) / playerCount) : 0;
            const insuredCount = sortedPlayers.filter(p => p.insurance && Object.keys(p.insurance).length > 0).length;

            // Track rankings before the popup closes
            useEffect(() => {
                if (showEventPopup) {
                    // Save current rankings when popup is shown
                    const rankings = {};
                    sortedPlayers.forEach((player, index) => {
                        rankings[player.id] = index;
                    });
                    setPreviousRankings(rankings);
                }
            }, [showEventPopup]);

            return (
                <div className="display-screen">
                    {showEventPopup && game.lastSharedEvent && (
                        <>
                            <div className="event-overlay" onClick={() => setShowEventPopup(false)}></div>
                            <div className="event-popup" style={{ maxWidth: '600px', maxHeight: '90vh', overflowY: 'auto', fontSize: '0.85em' }}>
                                <div className="event-title" style={{ fontSize: '1.8em', marginBottom: '8px' }}>
                                    ⚡ EVENT!
                                </div>
                                
                                {/* Main Event Display */}
                                <div style={{ 
                                    padding: '20px',
                                    background: game.lastSharedEvent.cost > 10000 ? 
                                        'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)' : 
                                        'linear-gradient(135deg, #80b2e8 0%, #1e1d4c 100%)',
                                    borderRadius: '12px',
                                    color: 'white',
                                    marginBottom: '20px',
                                    textAlign: 'center'
                                }}>
                                    <div style={{ fontSize: '1.8em', marginBottom: '12px' }}>
                                        {game.lastSharedEvent.name}
                                    </div>
                                    <div style={{ fontSize: '1.4em', fontWeight: 'bold' }}>
                                        Cost: £{game.lastSharedEvent.cost.toLocaleString()}
                                    </div>
                                </div>

                                {/* Summary Statistics */}
                                <div>
                                    <h3 style={{ marginBottom: '12px', color: '#80b2e8', fontSize: '1.2em' }}>
                                        Class Impact Summary:
                                    </h3>
                                    {(() => {
                                        const insured = displayEvents.filter(e => e.covered);
                                        const uninsured = displayEvents.filter(e => !e.covered);
                                        const insuredAvg = insured.length > 0 ? Math.round(insured.reduce((sum, e) => sum + e.actualCost, 0) / insured.length) : 0;
                                        const uninsuredAvg = uninsured.length > 0 ? Math.round(uninsured.reduce((sum, e) => sum + e.actualCost, 0) / uninsured.length) : 0;
                                        
                                        return (
                                            <div style={{ display: 'flex', gap: '15px', marginBottom: '20px' }}>
                                                <div style={{ 
                                                    flex: 1,
                                                    padding: '15px',
                                                    background: '#d4edda',
                                                    borderRadius: '8px',
                                                    borderLeft: '5px solid #28a745'
                                                }}>
                                                    <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#155724', marginBottom: '8px' }}>
                                                        ✓ Insured
                                                    </div>
                                                    <div style={{ fontSize: '1.5em', fontWeight: 'bold', color: '#28a745' }}>
                                                        {insured.length} {insured.length === 1 ? 'student' : 'students'}
                                                    </div>
                                                    <div style={{ fontSize: '0.95em', color: '#155724', marginTop: '5px' }}>
                                                        Paid average: £{insuredAvg.toLocaleString()}
                                                    </div>
                                                </div>
                                                
                                                <div style={{ 
                                                    flex: 1,
                                                    padding: '15px',
                                                    background: '#f8d7da',
                                                    borderRadius: '8px',
                                                    borderLeft: '5px solid #dc3545'
                                                }}>
                                                    <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#721c24', marginBottom: '8px' }}>
                                                        ✗ Uninsured
                                                    </div>
                                                    <div style={{ fontSize: '1.5em', fontWeight: 'bold', color: '#dc3545' }}>
                                                        {uninsured.length} {uninsured.length === 1 ? 'student' : 'students'}
                                                    </div>
                                                    <div style={{ fontSize: '0.95em', color: '#721c24', marginTop: '5px' }}>
                                                        Paid average: £{uninsuredAvg.toLocaleString()}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>

                                <button 
                                    style={{ marginTop: '20px', width: '100%', fontSize: '1.1em', padding: '15px' }}
                                    onClick={() => {
                                        setShowEventPopup(false);
                                        // Trigger leaderboard cascade animation (2s for 10 players)
                                        setAnimatingLeaderboard(true);
                                        setTimeout(() => setAnimatingLeaderboard(false), 2000);
                                    }}
                                >
                                    Close
                                </button>
                            </div>
                        </>
                    )}
                    <div className="display-header" style={{ padding: '15px 30px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div style={{ display: 'flex', alignItems: 'center' }}>
                                <img src={`data:image/png;base64,${logoBase64}`} alt="Tenent Logo" style={{ height: '50px', marginRight: '12px' }} />
                                <h1 style={{ fontSize: '1.5em', margin: 0 }}>Life Happens: Understanding Insurance</h1>
                            </div>
                            {game.started && <div style={{ fontSize: '1.5em', fontWeight: 'bold' }}>
                                {game.currentMonth > GAME_CONFIG.monthsPerGame ? (
                                    <span style={{ color: '#4CAF50' }}>🏁 GAME OVER - Final Results</span>
                                ) : (
                                    <>Month {game.currentMonth} / {GAME_CONFIG.monthsPerGame}</>
                                )}
                            </div>}
                            {!game.started && <div className="room-code" style={{ 
                                fontSize: '2em', 
                                padding: '10px 20px',
                                margin: 0,
                                letterSpacing: '6px'
                            }}>{game.code}</div>}
                        </div>
                    </div>

                    <div className="container" style={{ paddingTop: '10px' }}>
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '20px', paddingBottom: '80px' }}>
                            <div className="card">
                                <h2>🏆 Leaderboard (Top 10)</h2>
                                <div className="leaderboard">
                                    {sortedPlayers.length === 0 ? (
                                        <p style={{ textAlign: 'center', color: '#666', padding: '40px' }}>
                                            Waiting for players to join...
                                        </p>
                                    ) : (
                                        sortedPlayers.slice(0, 10).map((player, index) => {
                                            // Calculate delay - #10 appears first (0s), #1 appears last (1.8s)
                                            const reverseIndex = 9 - index; // 9 for #1, 0 for #10
                                            const animationDelay = animatingLeaderboard ? `${reverseIndex * 0.2}s` : '0s';
                                            
                                            return (
                                                <div 
                                                    key={player.id} 
                                                    className={`leaderboard-item ${index < 3 ? 'top-3' : ''} ${animatingLeaderboard ? 'fade-cascade' : ''}`}
                                                    style={{ animationDelay }}
                                                >
                                                    <span className="rank">
                                                        {index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`}
                                                    </span>
                                                    <span className="player-name">{player.name}</span>
                                                    <span className="player-balance">£{player.balance.toLocaleString()}</span>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>

                            {game.started && (
                                <div className="card">
                                    <h2>📰 Recent Events</h2>
                                    <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                                        {/* Show recent shared events */}
                                        {game.lastSharedEvent ? (
                                            <div style={{ 
                                                padding: '15px', 
                                                marginBottom: '12px', 
                                                background: game.lastSharedEvent.cost > 10000 ? '#fff3cd' : '#e7f3ff',
                                                borderRadius: '8px',
                                                borderLeft: game.lastSharedEvent.cost > 10000 ? '4px solid #ff6b6b' : '4px solid #80b2e8'
                                            }}>
                                                <div style={{ fontSize: '1.1em', fontWeight: 'bold', marginBottom: '8px', color: '#333' }}>
                                                    Month {game.currentMonth - 1}: {game.lastSharedEvent.name}
                                                </div>
                                                <div style={{ fontSize: '1.3em', fontWeight: 'bold', color: '#dc3545' }}>
                                                    £{game.lastSharedEvent.cost.toLocaleString()} to replace/repair
                                                </div>
                                                {game.recentDisplayEvents && game.recentDisplayEvents.length > 0 && (
                                                    <div style={{ marginTop: '10px', fontSize: '0.85em', color: '#666' }}>
                                                        <strong>Class Impact:</strong>
                                                        <div style={{ marginTop: '5px' }}>
                                                            {game.recentDisplayEvents.filter(e => e.covered).length} students insured, {' '}
                                                            {game.recentDisplayEvents.filter(e => !e.covered).length} uninsured
                                                        </div>
                                                        <div>
                                                            Average paid: £{Math.round(
                                                                game.recentDisplayEvents.reduce((sum, e) => sum + e.actualCost, 0) / 
                                                                game.recentDisplayEvents.length
                                                            ).toLocaleString()}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ) : (
                                            <div>
                                                <p style={{ textAlign: 'center', color: '#666', padding: '20px' }}>
                                                    {game.currentMonth === 1 ? 
                                                        'No events yet - click "Next Month" to begin!' :
                                                        `Month ${game.currentMonth - 1}: No events occurred`
                                                    }
                                                </p>
                                            </div>
                                        )}
                                        
                                        {/* Show history of previous events if we want to track them */}
                                        {game.eventHistory && game.eventHistory.slice(0, 5).map((histEvent, i) => (
                                            <div key={i} style={{ 
                                                padding: '12px', 
                                                marginBottom: '8px', 
                                                background: '#f8f9fa',
                                                borderRadius: '6px',
                                                fontSize: '0.9em',
                                                borderLeft: '3px solid #ccc'
                                            }}>
                                                <div style={{ fontWeight: 'bold', color: '#666' }}>
                                                    Month {histEvent.month}: {histEvent.name}
                                                </div>
                                                <div style={{ color: '#999', fontSize: '0.85em' }}>
                                                    £{histEvent.cost.toLocaleString()}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Game control button in bottom corner */}
                        <div style={{ 
                            position: 'fixed', 
                            bottom: '20px', 
                            right: '20px',
                            zIndex: 100
                        }}>
                            {!game.started ? (
                                <div>
                                    <button 
                                        style={{ fontSize: '1em', padding: '12px 24px', marginBottom: '10px', display: 'block' }}
                                        onClick={() => {
                                            console.log('Starting game...');
                                            window.gameManager.startGame();
                                            console.log('Game started, state:', window.gameManager.game);
                                            onUpdate();
                                        }}
                                    >
                                        ▶️ Start Game
                                    </button>
                                    <button 
                                        className="btn-danger"
                                        style={{ fontSize: '0.9em', padding: '8px 16px' }}
                                        onClick={() => {
                                            if (confirm('Reset game? This will remove all players and start fresh.')) {
                                                window.gameManager.resetGame();
                                                onUpdate();
                                            }
                                        }}
                                    >
                                        🔄 Reset Game
                                    </button>
                                </div>
                            ) : (
                                <div>
                                    {game.currentMonth <= GAME_CONFIG.monthsPerGame ? (
                                        <button 
                                            style={{ fontSize: '1em', padding: '12px 24px' }}
                                            onClick={() => {
                                                window.gameManager.advanceMonth();
                                                onUpdate();
                                            }}
                                        >
                                            Next Month ⏭️
                                        </button>
                                    ) : (
                                        <button 
                                            className="btn-danger"
                                            style={{ fontSize: '1em', padding: '12px 24px' }}
                                            onClick={() => {
                                                if (confirm('End game and show final results? This will reset for a new game.')) {
                                                    window.gameManager.resetGame();
                                                    onUpdate();
                                                }
                                            }}
                                        >
                                            🏁 End Game & Reset
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<App />);
    </script>
</body>
</html>
