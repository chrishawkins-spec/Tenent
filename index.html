<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Happens - Insurance Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .display-container {
            max-width: 100vw;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        h3 {
            color: #555;
            margin-bottom: 10px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .room-code {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            padding: 30px;
            background: #f0f4ff;
            border-radius: 12px;
            margin: 20px 0;
            letter-spacing: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .leaderboard {
            margin-top: 20px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 8px;
            align-items: center;
            transition: all 0.3s;
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }

        .leaderboard-item.top-3 {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            font-weight: 600;
        }

        .rank {
            font-size: 1.5em;
            font-weight: bold;
            margin-right: 15px;
            min-width: 40px;
        }

        .player-name {
            flex: 1;
            font-size: 1.1em;
        }

        .player-balance {
            font-size: 1.2em;
            font-weight: bold;
        }

        .insurance-shop {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .insurance-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
            background: white;
        }

        .insurance-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .insurance-card.owned {
            border-color: #28a745;
            background: #f0fff4;
        }

        .insurance-price {
            color: #667eea;
            font-size: 1.3em;
            font-weight: bold;
            margin: 10px 0;
        }

        .insurance-coverage {
            color: #666;
            font-size: 0.9em;
            margin: 5px 0;
        }

        .hidden {
            display: none;
        }

        .game-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .display-screen {
            background: #1a1a2e;
            min-height: 100vh;
            color: white;
        }

        .display-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            text-align: center;
        }

        .display-header h1 {
            color: white;
            font-size: 3em;
        }

        .display-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 30px;
        }

        .month-indicator {
            text-align: center;
            font-size: 2em;
            color: #667eea;
            margin: 20px 0;
            font-weight: bold;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .event-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            z-index: 1000;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .event-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .event-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .event-cost {
            font-size: 2.5em;
            font-weight: bold;
            color: #dc3545;
            margin: 20px 0;
            text-align: center;
        }

        .event-cost.covered {
            color: #28a745;
        }

        @media (max-width: 768px) {
            .display-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyBnA3ABaY2jdDqXPpzOSLmbc_V_BVALkpQ",
            authDomain: "tenent-insurance-game.firebaseapp.com",
            databaseURL: "https://tenent-insurance-game-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "tenent-insurance-game",
            storageBucket: "tenent-insurance-game.firebasestorage.app",
            messagingSenderId: "863690278726",
            appId: "1:863690278726:web:cd05ea67906dbc01000747"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        // Game configuration
        const GAME_CONFIG = {
            startingBalance: 5000,
            monthlyIncome: 400,
            monthsPerGame: 24,
            eventProbability: 0.3,
        };

        // Insurance types with multiple tiers
        const INSURANCE_TYPES = {
            // PHONE INSURANCE
            phone_budget: {
                name: "Phone Insurance (Budget)",
                category: "phone",
                monthlyCost: 8,
                covers: ["phone_damage", "theft"],
                deductible: 100,
                brand: "budget",
                claimDifficulty: "hard",
                starRating: 1
            },
            phone_premium: {
                name: "Phone Insurance (Premium)",
                category: "phone",
                monthlyCost: 15,
                covers: ["phone_damage", "theft"],
                deductible: 50,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5
            },

            // CONTENTS INSURANCE
            contents_basic: {
                name: "Contents Insurance (Basic)",
                category: "contents",
                monthlyCost: 12,
                covers: ["burglary", "fire", "water_damage"],
                deductible: 250,
                brand: "budget",
                claimDifficulty: "medium",
                starRating: 3
            },
            contents_standard: {
                name: "Contents Insurance (Standard)",
                category: "contents",
                monthlyCost: 18,
                covers: ["burglary", "fire", "water_damage", "theft"],
                deductible: 150,
                brand: "standard",
                claimDifficulty: "easy",
                starRating: 4
            },
            contents_comprehensive: {
                name: "Contents Insurance (Comprehensive)",
                category: "contents",
                monthlyCost: 25,
                covers: ["burglary", "fire", "water_damage", "theft"],
                deductible: 50,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5
            },

            // CAR INSURANCE
            car_third_party: {
                name: "Car Insurance (Third Party Only)",
                category: "car",
                monthlyCost: 45,
                covers: ["car_liability"],
                deductible: 0,
                brand: "basic",
                claimDifficulty: "hard",
                starRating: 1,
                description: "Only covers damage you cause to others"
            },
            car_tpft: {
                name: "Car Insurance (Third Party, Fire & Theft)",
                category: "car",
                monthlyCost: 65,
                covers: ["car_liability", "car_fire", "car_theft"],
                deductible: 250,
                brand: "standard",
                claimDifficulty: "medium",
                starRating: 3,
                description: "Covers others + if your car is stolen or burns"
            },
            car_comprehensive: {
                name: "Car Insurance (Fully Comprehensive)",
                category: "car",
                monthlyCost: 95,
                covers: ["car_liability", "car_fire", "car_theft", "car_damage"],
                deductible: 200,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5,
                description: "Covers everything including your own car damage"
            },

            // GADGET INSURANCE
            gadget_basic: {
                name: "Gadget Insurance (Basic)",
                category: "gadget",
                monthlyCost: 8,
                covers: ["laptop_damage"],
                deductible: 100,
                brand: "budget",
                claimDifficulty: "hard",
                starRating: 1
            },
            gadget_premium: {
                name: "Gadget Insurance (Premium)",
                category: "gadget",
                monthlyCost: 14,
                covers: ["phone_damage", "laptop_damage", "theft"],
                deductible: 50,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5
            },

            // LIABILITY INSURANCE
            liability_basic: {
                name: "Personal Liability (Basic)",
                category: "liability",
                monthlyCost: 6,
                covers: ["liability"],
                deductible: 100,
                brand: "budget",
                claimDifficulty: "medium",
                starRating: 2
            },
            liability_premium: {
                name: "Personal Liability (Premium)",
                category: "liability",
                monthlyCost: 12,
                covers: ["liability"],
                deductible: 0,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5
            },

            // BICYCLE INSURANCE
            bicycle_budget: {
                name: "Bicycle Insurance (Budget)",
                category: "bicycle",
                monthlyCost: 7,
                covers: ["bike_theft"],
                deductible: 75,
                brand: "budget",
                claimDifficulty: "hard",
                starRating: 1
            },
            bicycle_premium: {
                name: "Bicycle Insurance (Premium)",
                category: "bicycle",
                monthlyCost: 12,
                covers: ["bike_theft", "bike_damage"],
                deductible: 30,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5
            },

            // PET INSURANCE
            pet_accident: {
                name: "Pet Insurance (Accident Only)",
                category: "pet",
                monthlyCost: 10,
                covers: ["pet_emergency"],
                deductible: 200,
                brand: "budget",
                claimDifficulty: "medium",
                starRating: 2,
                description: "Covers injuries only"
            },
            pet_comprehensive: {
                name: "Pet Insurance (Full Cover)",
                category: "pet",
                monthlyCost: 25,
                covers: ["pet_emergency", "pet_liability"],
                deductible: 100,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5,
                description: "Illness + injury + third party liability"
            },

            // TRAVEL INSURANCE
            travel_basic: {
                name: "Travel Insurance (Basic)",
                category: "travel",
                monthlyCost: 8,
                covers: ["travel_issue"],
                deductible: 200,
                brand: "budget",
                claimDifficulty: "hard",
                starRating: 1,
                description: "Medical abroad + cancellation only"
            },
            travel_comprehensive: {
                name: "Travel Insurance (Comprehensive)",
                category: "travel",
                monthlyCost: 15,
                covers: ["travel_issue", "travel_emergency"],
                deductible: 50,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5,
                description: "Everything + gadgets + emergency medical"
            },

            // CYBER/IDENTITY PROTECTION
            cyber_standard: {
                name: "Cyber Protection (Standard)",
                category: "cyber",
                monthlyCost: 4,
                covers: ["cyber_theft"],
                deductible: 100,
                brand: "standard",
                claimDifficulty: "medium",
                starRating: 3,
                description: "Identity theft + fraud monitoring"
            },
            cyber_premium: {
                name: "Cyber Protection (Premium)",
                category: "cyber",
                monthlyCost: 8,
                covers: ["cyber_theft"],
                deductible: 0,
                brand: "premium",
                claimDifficulty: "easy",
                starRating: 5,
                description: "Full coverage + credit monitoring + recovery"
            }
        };

        // Events database
        const EVENTS = {
            common: [
                { name: "Phone screen cracks", cost: 225, type: "phone_damage", probability: 0.10 },
                { name: "Bike stolen from school", cost: 350, type: "bike_theft", probability: 0.08 },
                { name: "Minor car scratch in car park", cost: 400, type: "car_damage", probability: 0.08 },
                { name: "Laptop charger breaks", cost: 60, type: "gadget", probability: 0.06 },
                { name: "Spilled drink on laptop", cost: 550, type: "laptop_damage", probability: 0.06 },
                { name: "Sports kit bag lost", cost: 120, type: "theft", probability: 0.08 },
                { name: "Glasses broken", cost: 300, type: "personal_items", probability: 0.07 },
                { name: "School bag stolen with belongings", cost: 150, type: "theft", probability: 0.09 },
                { name: "Train ticket fine (forgot railcard)", cost: 80, type: "penalty", probability: 0.07 },
                { name: "Parking fine", cost: 60, type: "penalty", probability: 0.08 },
                { name: "Phone dropped in toilet", cost: 250, type: "phone_damage", probability: 0.08 },
                { name: "Headphones lost", cost: 100, type: "personal_items", probability: 0.07 },
                { name: "Watch broken", cost: 150, type: "personal_items", probability: 0.06 },
                { name: "Library book damaged", cost: 40, type: "penalty", probability: 0.06 }
            ],
            uncommon: [
                { name: "Minor car accident (fender bender)", cost: 1850, type: "car_damage", probability: 0.06 },
                { name: "Water damage ruins electronics", cost: 1050, type: "water_damage", probability: 0.04 },
                { name: "Car break-in, items stolen", cost: 800, type: "theft", probability: 0.04 },
                { name: "Phone stolen on the bus", cost: 650, type: "theft", probability: 0.05 },
                { name: "Accidentally damage friend's property", cost: 550, type: "liability", probability: 0.03 },
                { name: "Accidentally leave tap running, flood bathroom", cost: 2500, type: "water_damage", probability: 0.03 },
                { name: "E-scooter stolen", cost: 800, type: "theft", probability: 0.05 },
                { name: "Identity theft - fraudulent purchases", cost: 1500, type: "cyber_theft", probability: 0.04 },
                { name: "Lost passport, emergency replacement needed", cost: 300, type: "travel_issue", probability: 0.03 },
                { name: "Pet needs emergency vet care", cost: 900, type: "pet_emergency", probability: 0.04 },
                { name: "Storm damages car (tree branch)", cost: 1800, type: "car_damage", probability: 0.03 }
            ],
            rare: [
                { name: "Car written off in accident (your fault)", cost: 16000, type: "car_damage", probability: 0.012 },
                { name: "Car stolen and not recovered", cost: 15000, type: "car_theft", probability: 0.012 },
                { name: "Burglary - flat cleaned out", cost: 19000, type: "burglary", probability: 0.012 },
                { name: "Flood flat, damage downstairs neighbor", cost: 10000, type: "liability", probability: 0.008 },
                { name: "Major car accident - injured other driver", cost: 27500, type: "car_liability", probability: 0.012 },
                { name: "Fire damages belongings", cost: 16500, type: "fire", probability: 0.008 },
                { name: "Your dog bites someone - sued for damages", cost: 8000, type: "pet_liability", probability: 0.008 },
                { name: "Boiler breakdown, need emergency replacement", cost: 3500, type: "home_emergency", probability: 0.010 }
            ],
            very_rare: [
                { name: "Multi-car pile-up on motorway", cost: 475000, type: "car_liability", probability: 0.002 },
                { name: "House fire destroys entire home", cost: 185000, type: "fire", probability: 0.0015 },
                { name: "Major fire spreads to neighbors", cost: 520000, type: "liability", probability: 0.0008 },
                { name: "Cycling accident - seriously injure someone", cost: 300000, type: "liability", probability: 0.0015 },
                { name: "Cyber attack - bank account drained", cost: 25000, type: "cyber_theft", probability: 0.002 },
                { name: "Trip abroad, serious injury, air ambulance home", cost: 80000, type: "travel_emergency", probability: 0.0015 }
            ]
        };

        // BroadcastChannel for cross-tab communication
        const channel = new BroadcastChannel('insurance-game');

        // Game state manager with Firebase - Single global game
        class GameStateManager {
            constructor() {
                this.gameRef = database.ref('game'); // Single global game
                this.game = {
                    players: {},
                    started: false,
                    currentMonth: 0,
                    paused: false,
                    recentDisplayEvents: [],
                    eventHistory: []
                };
            }

            save() {
                // Save to Firebase
                this.gameRef.set(this.game);
            }

            // Watch the game for real-time updates
            watchGame(callback) {
                this.gameRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        this.game = data;
                        callback();
                    }
                });
                
                return () => this.gameRef.off();
            }

            initGame() {
                // Initialize or load existing game
                return this.gameRef.once('value').then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        this.game = data;
                    } else {
                        // Create new game if doesn't exist
                        this.game = {
                            players: {},
                            started: false,
                            currentMonth: 0,
                            paused: false,
                            recentDisplayEvents: [],
                            eventHistory: []
                        };
                        this.save();
                    }
                });
            }

            resetGame() {
                // Teacher can reset the game
                this.game = {
                    players: {},
                    started: false,
                    currentMonth: 0,
                    paused: false,
                    recentDisplayEvents: [],
                    eventHistory: []
                };
                this.save();
            }

            joinGame(playerName) {
                const playerId = Math.random().toString(36).substring(2, 15);
                this.game.players[playerId] = {
                    id: playerId,
                    name: playerName,
                    balance: GAME_CONFIG.startingBalance,
                    insurance: {},
                    events: [],
                    pendingClaims: []
                };
                this.save();
                return playerId;
            }

            startGame() {
                this.game.started = true;
                this.game.currentMonth = 1;
                this.save();
            }

            selectRandomEvent() {
                const allEvents = [
                    ...EVENTS.common,
                    ...EVENTS.uncommon,
                    ...EVENTS.rare,
                    ...EVENTS.very_rare
                ];

                const totalProbability = allEvents.reduce((sum, e) => sum + e.probability, 0);
                let random = Math.random() * totalProbability;

                for (const event of allEvents) {
                    random -= event.probability;
                    if (random <= 0) return event;
                }

                return allEvents[0];
            }

            applyEvent(player, event) {
                const eventCopy = { ...event, timestamp: Date.now(), id: Math.random().toString(36).substring(2, 15) };
                let actualCost = event.cost;
                let covered = false;
                let insuranceUsed = null;

                if (event.cost > 0) {
                    for (const [insuranceType, insurance] of Object.entries(INSURANCE_TYPES)) {
                        if (player.insurance[insuranceType] && insurance.covers.includes(event.type)) {
                            covered = true;
                            insuranceUsed = insuranceType;
                            actualCost = insurance.deductible;
                            
                            // If not premium insurance, create a claim process
                            if (insurance.claimDifficulty !== 'easy') {
                                const claimSteps = this.generateClaimSteps(insurance.claimDifficulty);
                                player.pendingClaims.push({
                                    eventId: eventCopy.id,
                                    insuranceType: insuranceType,
                                    difficulty: insurance.claimDifficulty,
                                    steps: claimSteps,
                                    currentStep: 0,
                                    completed: false,
                                    refundAmount: event.cost - insurance.deductible
                                });
                            }
                            break;
                        }
                    }
                }

                eventCopy.actualCost = actualCost;
                eventCopy.covered = covered;
                eventCopy.insuranceUsed = insuranceUsed;
                eventCopy.needsClaim = covered && INSURANCE_TYPES[insuranceUsed]?.claimDifficulty !== 'easy';
                player.balance -= actualCost;
                player.events.push(eventCopy);
            }

            generateClaimSteps(difficulty) {
                // 5-star rating (easy) - instant payout
                const easySteps = [
                    { text: "Submit claim form online", duration: 30, canFail: false },
                    { text: "Claim approved!", duration: 30, canFail: false }
                ];
                
                // 2-4 star rating (medium) - standard process
                const mediumSteps = [
                    { text: "Fill out claim form", duration: 45, canFail: false },
                    { text: "Submit proof of purchase", duration: 45, canFail: true, failChance: 0.25, failMessage: "Document rejected - please resubmit" },
                    { text: "Wait for claim review (2-3 days)", duration: 60, canFail: false },
                    { text: "Claim approved!", duration: 30, canFail: false }
                ];
                
                // 1-star rating (hard) - slow, error-prone process
                const hardSteps = [
                    { text: "Call claims hotline (20 min wait)", duration: 60, canFail: false },
                    { text: "Fill out lengthy claim form", duration: 90, canFail: false },
                    { text: "Submit proof of purchase", duration: 60, canFail: true, failChance: 0.4, failMessage: "Insurer says they have lost your documentation - please resubmit" },
                    { text: "Submit additional documentation", duration: 75, canFail: true, failChance: 0.35, failMessage: "Wrong format - please resubmit" },
                    { text: "Wait for assessor visit", duration: 90, canFail: false },
                    { text: "Wait for claim review (5-7 days)", duration: 120, canFail: false },
                    { text: "Respond to request for more information", duration: 60, canFail: true, failChance: 0.3, failMessage: "Insurer says they have lost your documentation - go back to previous step" },
                    { text: "Wait for final review", duration: 90, canFail: false },
                    { text: "Claim approved!", duration: 30, canFail: false }
                ];

                switch(difficulty) {
                    case 'easy': return easySteps;
                    case 'medium': return mediumSteps;
                    case 'hard': return hardSteps;
                    default: return mediumSteps;
                }
            }

            advanceClaimStep(roomCode, playerId, eventId) {
                const room = this.rooms[roomCode];
                if (!game || !game.players) return false;

                const player = game.players[playerId];
                if (!player) return false;

                const claim = player.pendingClaims.find(c => c.eventId === eventId);
                if (!claim) return false;

                // Check if currently waiting for timer
                if (claim.waitingUntil && Date.now() < claim.waitingUntil) {
                    return { waiting: true, remainingSeconds: Math.ceil((claim.waitingUntil - Date.now()) / 1000) };
                }

                // Check if step can fail
                const currentStepData = claim.steps[claim.currentStep];
                if (currentStepData.canFail && Math.random() < currentStepData.failChance) {
                    // Step failed - user must repeat this step
                    claim.failMessage = currentStepData.failMessage;
                    claim.waitingUntil = Date.now() + (currentStepData.duration * 1000);
                    claim.stepAttempts = (claim.stepAttempts || 0) + 1;
                    this.save();
                    return { failed: true, message: currentStepData.failMessage, waitSeconds: currentStepData.duration };
                }

                // Step succeeded - set timer for this step
                claim.failMessage = null;
                claim.waitingUntil = Date.now() + (currentStepData.duration * 1000);
                claim.currentStep++;
                
                if (claim.currentStep >= claim.steps.length) {
                    claim.completed = true;
                    claim.completedAt = Date.now();
                    // Refund the amount (minus deductible)
                    player.balance += claim.refundAmount;
                }

                this.save();
                return { success: true, waitSeconds: currentStepData.duration };
            }

            advanceMonth(roomCode) {
                const room = this.rooms[roomCode];
                if (!room || !game.started) return;

                // Clear previous display events
                game.recentDisplayEvents = [];

                // Select ONE event that will happen to everyone (or no one)
                let sharedEvent = null;
                if (Math.random() < GAME_CONFIG.eventProbability) {
                    sharedEvent = this.selectRandomEvent();
                }

                Object.values(game.players).forEach(player => {
                    player.balance += GAME_CONFIG.monthlyIncome;

                    Object.keys(player.insurance).forEach(insuranceType => {
                        player.balance -= INSURANCE_TYPES[insuranceType].monthlyCost;
                    });

                    // Apply the shared event to all players
                    if (sharedEvent) {
                        this.applyEvent(player, sharedEvent);
                        
                        // Add to display events
                        const latestEvent = player.events[player.events.length - 1];
                        game.recentDisplayEvents.push({
                            ...latestEvent,
                            playerName: player.name,
                            playerId: player.id
                        });
                    }
                });

                // Store the shared event for display
                game.lastSharedEvent = sharedEvent;

                // Add to event history if there was an event
                if (sharedEvent) {
                    if (!game.eventHistory) game.eventHistory = [];
                    game.eventHistory.unshift({
                        month: game.currentMonth,
                        name: sharedEvent.name,
                        cost: sharedEvent.cost,
                        type: sharedEvent.type
                    });
                    // Keep only last 10 events
                    if (game.eventHistory.length > 10) {
                        game.eventHistory = game.eventHistory.slice(0, 10);
                    }
                }

                game.currentMonth++;
                
                if (game.currentMonth > GAME_CONFIG.monthsPerGame) {
                    game.started = false;
                }

                this.save();
            }

            buyInsurance(playerId, insuranceType) {
                const player = this.game.players[playerId];
                if (!player || player.insurance[insuranceType]) return false;

                // Check if player already has insurance in this category
                const newInsurance = INSURANCE_TYPES[insuranceType];
                for (const [ownedType, ownedInsurance] of Object.entries(INSURANCE_TYPES)) {
                    if (player.insurance[ownedType] && ownedInsurance.category === newInsurance.category) {
                        // Cancel existing insurance in same category
                        delete player.insurance[ownedType];
                    }
                }

                player.insurance[insuranceType] = true;
                this.save();
                return true;
            }

            cancelInsurance(playerId, insuranceType) {
                const player = this.game.players[playerId];
                if (!player) return false;

                delete player.insurance[insuranceType];
                this.save();
                return true;
            }

            advanceClaimStep(playerId, eventId) {
                const player = this.game.players[playerId];
                if (!player) return false;

                const claim = player.pendingClaims.find(c => c.eventId === eventId);
                if (!claim) return false;

                // Check if currently waiting for timer
                if (claim.waitingUntil && Date.now() < claim.waitingUntil) {
                    return { waiting: true, remainingSeconds: Math.ceil((claim.waitingUntil - Date.now()) / 1000) };
                }

                // Check if step can fail
                const currentStepData = claim.steps[claim.currentStep];
                if (currentStepData.canFail && Math.random() < currentStepData.failChance) {
                    // Step failed - user must repeat this step
                    claim.failMessage = currentStepData.failMessage;
                    claim.waitingUntil = Date.now() + (currentStepData.duration * 1000);
                    claim.stepAttempts = (claim.stepAttempts || 0) + 1;
                    this.save();
                    return { failed: true, message: currentStepData.failMessage, waitSeconds: currentStepData.duration };
                }

                // Step succeeded - set timer for this step
                claim.failMessage = null;
                claim.waitingUntil = Date.now() + (currentStepData.duration * 1000);
                claim.currentStep++;
                
                if (claim.currentStep >= claim.steps.length) {
                    claim.completed = true;
                    claim.completedAt = Date.now();
                    // Refund the amount (minus deductible)
                    player.balance += claim.refundAmount;
                }

                this.save();
                return { success: true, waitSeconds: currentStepData.duration };
            }

            advanceMonth() {
                if (!this.game.started) return;

                // Clear previous display events
                this.game.recentDisplayEvents = [];

                // Select ONE event that will happen to everyone (or no one)
                let sharedEvent = null;
                if (Math.random() < GAME_CONFIG.eventProbability) {
                    sharedEvent = this.selectRandomEvent();
                }

                Object.values(this.game.players).forEach(player => {
                    player.balance += GAME_CONFIG.monthlyIncome;

                    Object.keys(player.insurance).forEach(insuranceType => {
                        player.balance -= INSURANCE_TYPES[insuranceType].monthlyCost;
                    });

                    // Apply the shared event to all players
                    if (sharedEvent) {
                        this.applyEvent(player, sharedEvent);
                        
                        // Add to display events
                        const latestEvent = player.events[player.events.length - 1];
                        this.game.recentDisplayEvents.push({
                            ...latestEvent,
                            playerName: player.name,
                            playerId: player.id
                        });
                    }
                });

                // Store the shared event for display
                this.game.lastSharedEvent = sharedEvent;

                // Add to event history if there was an event
                if (sharedEvent) {
                    if (!this.game.eventHistory) this.game.eventHistory = [];
                    this.game.eventHistory.unshift({
                        month: this.game.currentMonth,
                        name: sharedEvent.name,
                        cost: sharedEvent.cost,
                        type: sharedEvent.type
                    });
                    // Keep only last 10 events
                    if (this.game.eventHistory.length > 10) {
                        this.game.eventHistory = this.game.eventHistory.slice(0, 10);
                    }
                }

                this.game.currentMonth++;
                
                if (this.game.currentMonth > GAME_CONFIG.monthsPerGame) {
                    this.game.started = false;
                }

                this.save();
            }
        }

        const gameManager = new GameStateManager();

        // NOTE: This version uses localStorage + polling for same-device testing
        // For multi-device classroom use, you need Firebase version
        // See FIREBASE_SETUP_INSTRUCTIONS.md

        // Insurance information for help popups
        const INSURANCE_INFO = {
            phone: {
                title: "Phone Insurance",
                whatItCovers: "Protects your mobile phone from accidental damage, theft, and loss",
                potentialCosts: [
                    { event: "Phone screen cracks", cost: "£225" },
                    { event: "Phone dropped in toilet", cost: "£250" },
                    { event: "Phone stolen on the bus", cost: "£650" },
                    { event: "School bag stolen (with phone)", cost: "£150+" }
                ],
                whyYouNeedIt: "Phones are expensive to replace and easy to damage or lose. Without insurance, you'll pay the full replacement cost.",
                budgetVsPremium: "Budget: Cheaper monthly but long, frustrating claims process with potential for lost paperwork. Premium: More expensive but instant claims and lower excess."
            },
            contents: {
                title: "Contents Insurance",
                whatItCovers: "Protects your belongings in your home/flat from theft, fire, and water damage",
                potentialCosts: [
                    { event: "Burglary - flat cleaned out", cost: "£19,000" },
                    { event: "Fire damages belongings", cost: "£16,500" },
                    { event: "Water damage ruins electronics", cost: "£1,050" },
                    { event: "Flood bathroom damages items", cost: "£2,500" }
                ],
                whyYouNeedIt: "Your belongings (laptop, clothes, furniture, etc.) add up to thousands of pounds. One fire or burglary could wipe out everything.",
                budgetVsPremium: "Basic: Lower monthly cost but higher excess and some items not covered. Comprehensive: Covers almost everything with lower excess and faster claims."
            },
            car: {
                title: "Car Insurance",
                whatItCovers: "Protects you from costs related to car accidents, theft, and damage",
                potentialCosts: [
                    { event: "Minor car accident (fender bender)", cost: "£1,850" },
                    { event: "Car written off (your fault)", cost: "£16,000" },
                    { event: "Car stolen and not recovered", cost: "£15,000" },
                    { event: "Storm damages car", cost: "£1,800" },
                    { event: "Major accident - injured driver", cost: "£27,500" },
                    { event: "Multi-car pile-up on motorway", cost: "£475,000" }
                ],
                whyYouNeedIt: "Car accidents can cost tens of thousands - or even hundreds of thousands if you injure someone. Third Party Only is legally required but won't fix YOUR car.",
                budgetVsPremium: "Third Party Only: Legally required minimum, only covers damage to OTHERS. TP Fire & Theft: Adds theft and fire protection for your car. Fully Comprehensive: Covers everything including damage to your own car."
            },
            gadget: {
                title: "Gadget Insurance",
                whatItCovers: "Protects laptops, tablets, and electronics from damage and theft",
                potentialCosts: [
                    { event: "Spilled drink on laptop", cost: "£550" },
                    { event: "Laptop charger breaks", cost: "£60" },
                    { event: "Water damage ruins electronics", cost: "£1,050" },
                    { event: "School bag stolen with laptop", cost: "£150+" }
                ],
                whyYouNeedIt: "Laptops and tablets are essential for school/work. One accident could leave you unable to study or work.",
                budgetVsPremium: "Basic: Only covers laptop damage. Premium: Covers all gadgets including phones, plus theft protection."
            },
            liability: {
                title: "Personal Liability Insurance",
                whatItCovers: "Protects you if you accidentally injure someone or damage their property",
                potentialCosts: [
                    { event: "Accidentally damage friend's property", cost: "£550" },
                    { event: "Flood damages downstairs neighbor", cost: "£10,000" },
                    { event: "Cycling accident - injure someone", cost: "£300,000" },
                    { event: "Major fire spreads to neighbors", cost: "£520,000" }
                ],
                whyYouNeedIt: "If you accidentally hurt someone or damage their property, you could be sued for massive amounts. This protects you from financial ruin.",
                budgetVsPremium: "Basic: Covers most accidents with £100 excess. Premium: No excess and covers larger claims with easier process."
            },
            bicycle: {
                title: "Bicycle Insurance",
                whatItCovers: "Protects your bicycle from theft and damage",
                potentialCosts: [
                    { event: "Bike stolen from school", cost: "£350" }
                ],
                whyYouNeedIt: "Bikes are frequently stolen, especially from schools and public places. A good bike can cost hundreds to replace.",
                budgetVsPremium: "Budget: Only covers theft with higher excess. Premium: Covers theft AND damage (accidents) with lower excess."
            },
            pet: {
                title: "Pet Insurance",
                whatItCovers: "Covers veterinary bills and liability if your pet causes damage or injury",
                potentialCosts: [
                    { event: "Pet needs emergency vet care", cost: "£900" },
                    { event: "Your dog bites someone - sued", cost: "£8,000" }
                ],
                whyYouNeedIt: "Vet bills can be shockingly expensive, and you could be sued if your pet injures someone or damages property.",
                budgetVsPremium: "Accident Only: Cheaper but only covers injuries. Full Cover: Covers illness, injury, AND third party liability if your dog bites someone."
            },
            travel: {
                title: "Travel Insurance",
                whatItCovers: "Protects you from medical emergencies abroad, trip cancellations, and lost belongings",
                potentialCosts: [
                    { event: "Lost passport, emergency replacement", cost: "£300" },
                    { event: "Trip abroad - serious injury, air ambulance home", cost: "£80,000" }
                ],
                whyYouNeedIt: "Medical treatment abroad (especially outside Europe) can bankrupt you. An air ambulance home can cost £80,000+.",
                budgetVsPremium: "Basic: Covers medical emergencies and cancellation only. Comprehensive: Adds gadget cover, extreme sports, and emergency medical evacuation."
            },
            cyber: {
                title: "Cyber/Identity Protection",
                whatItCovers: "Protects you from identity theft, fraud, and cyber attacks",
                potentialCosts: [
                    { event: "Identity theft - fraudulent purchases", cost: "£1,500" },
                    { event: "Cyber attack - bank account drained", cost: "£25,000" }
                ],
                whyYouNeedIt: "Cyber criminals can steal your identity and drain your accounts. Recovery can be expensive and time-consuming.",
                budgetVsPremium: "Standard: Covers fraud with monitoring. Premium: No excess, includes credit monitoring and full recovery service."
            }
        };

        // Helper function to render star rating
        function renderStars(rating) {
            const stars = [];
            for (let i = 1; i <= 5; i++) {
                stars.push(i <= rating ? '⭐' : '☆');
            }
            return stars.join('');
        }

        // Main App Component
        function App() {
            const [view, setView] = useState('home');
            const [playerId, setPlayerId] = useState(null);
            const [playerName, setPlayerName] = useState(null);
            const [gameState, setGameState] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                // Initialize and watch the game
                gameManager.initGame().then(() => {
                    setGameState({...gameManager.game});
                    setLoading(false);
                    
                    // Now start watching for updates
                    const unsubscribe = gameManager.watchGame(() => {
                        setGameState({...gameManager.game});
                    });
                    return unsubscribe;
                });
            }, []);

            if (loading) {
                return (
                    <div className="container">
                        <div className="card" style={{ marginTop: '50px', textAlign: 'center' }}>
                            <h2>Loading game...</h2>
                            <p>Connecting to Firebase...</p>
                        </div>
                    </div>
                );
            }

            const handleTeacherView = () => {
                setView('display');
            };

            const handleJoinGame = (name) => {
                const id = gameManager.joinGame(name);
                setPlayerId(id);
                setPlayerName(name);
                // Give Firebase a moment to sync, then switch view
                setTimeout(() => {
                    setGameState({...gameManager.game});
                    setView('player');
                }, 500);
            };

            if (view === 'home') {
                return <HomeScreen onTeacherView={handleTeacherView} onStudentView={() => setView('join')} />;
            } else if (view === 'join') {
                return <JoinScreen onJoin={handleJoinGame} onBack={() => setView('home')} />;
            } else if (view === 'player') {
                return <PlayerScreen 
                    playerId={playerId} 
                    playerName={playerName} 
                    gameState={gameState}
                    onUpdate={() => setGameState({...gameManager.game})}
                />;
            } else if (view === 'display') {
                return <DisplayScreen 
                    gameState={gameState} 
                    onBack={() => setView('home')}
                    onUpdate={() => setGameState({...gameManager.game})}
                />;
            }
        }

        function HomeScreen({ onTeacherView, onStudentView }) {
            return (
                <div className="container">
                    <div className="card" style={{ marginTop: '50px', textAlign: 'center' }}>
                        <h1>🛡️ Life Happens</h1>
                        <p style={{ fontSize: '1.2em', margin: '20px 0', color: '#666' }}>
                            Learn how insurance works through real-life scenarios
                        </p>
                        <div style={{ marginTop: '40px' }}>
                            <button style={{ margin: '10px', width: '200px' }} onClick={onTeacherView}>
                                🎮 Teacher View (Display)
                            </button>
                            <button style={{ margin: '10px', width: '200px' }} onClick={onStudentView}>
                                👤 Join Game (Student)
                            </button>
                        </div>
                        <p style={{ fontSize: '0.9em', marginTop: '30px', color: '#999' }}>
                            All students and teachers share the same game - just open the URL!
                        </p>
                    </div>
                </div>
            );
        }

        function JoinScreen({ onJoin, onBack }) {
            const [name, setName] = useState('');

            return (
                <div className="container">
                    <div className="card" style={{ marginTop: '50px' }}>
                        <h2>Join Game</h2>
                        <div>
                            <label>Your Name:</label>
                            <input type="text" placeholder="Enter your name" value={name} onChange={(e) => setName(e.target.value)} />
                        </div>
                        <button onClick={() => {
                            const trimmedName = name.trim();
                            if (!trimmedName) {
                                alert('Please enter your name');
                                return;
                            }
                            onJoin(trimmedName);
                        }}>Join Game</button>
                        <button className="btn-secondary" style={{ marginLeft: '10px' }} onClick={onBack}>Back</button>
                    </div>
                </div>
            );
        }

        function DisplayJoinScreen({ onJoin, onBack }) {
            const [code, setCode] = useState('');

            return (
                <div className="container">
                    <div className="card" style={{ marginTop: '50px' }}>
                        <h2>Display Screen</h2>
                        <div>
                            <label>Room Code:</label>
                            <input 
                                type="text" 
                                placeholder="Enter room code" 
                                value={code} 
                                onChange={(e) => setCode(e.target.value.toUpperCase())}
                                style={{ textTransform: 'uppercase' }}
                            />
                        </div>
                        <button onClick={() => {
                            const trimmedCode = code.trim();
                            // Load room from Firebase before joining
                            database.ref('rooms/' + trimmedCode).once('value').then((snapshot) => {
                                const roomData = snapshot.val();
                                if (roomData) {
                                    gameManager.rooms[trimmedCode] = roomData;
                                    onJoin(trimmedCode);
                                } else {
                                    alert('Room not found');
                                }
                            });
                        }}>Load Display</button>
                        <button className="btn-secondary" style={{ marginLeft: '10px' }} onClick={onBack}>Back</button>
                    </div>
                </div>
            );
        }

        function PlayerScreen({ playerId, playerName, gameState, onUpdate }) {
            const [showEventPopup, setShowEventPopup] = useState(false);
            const [currentEvent, setCurrentEvent] = useState(null);
            const [claimTimers, setClaimTimers] = useState({});
            const [claimMessages, setClaimMessages] = useState({});
            const [showInsuranceInfo, setShowInsuranceInfo] = useState(null);

            const game = gameState;
            if (!game) {
                return (
                    <div className="container">
                        <div className="card">
                            <h2>Loading game data...</h2>
                            <p>Waiting for game to initialize...</p>
                        </div>
                    </div>
                );
            }
            
            if (!game.players) {
                game.players = {};
            }

            const player = game.players[playerId];
            if (!player) {
                return (
                    <div className="container">
                        <div className="card">
                            <h2>Player not found</h2>
                            <p>Your player data is loading...</p>
                            <button onClick={onUpdate}>Refresh</button>
                        </div>
                    </div>
                );
            }

            // Check for new events and show popup
            useEffect(() => {
                if (player.events.length > 0) {
                    const latestEvent = player.events[player.events.length - 1];
                    const eventAge = Date.now() - latestEvent.timestamp;
                    
                    // Show popup if event is less than 5 seconds old
                    if (eventAge < 5000 && !showEventPopup) {
                        setCurrentEvent(latestEvent);
                        setShowEventPopup(true);
                    }
                }
            }, [player.events]);

            // Update timers for claims
            useEffect(() => {
                const interval = setInterval(() => {
                    if (player.pendingClaims) {
                        const newTimers = {};
                        player.pendingClaims.forEach(claim => {
                            if (claim.waitingUntil) {
                                const remaining = Math.max(0, Math.ceil((claim.waitingUntil - Date.now()) / 1000));
                                newTimers[claim.eventId] = remaining;
                            }
                        });
                        setClaimTimers(newTimers);
                    }
                }, 1000);

                return () => clearInterval(interval);
            }, [player.pendingClaims]);

            const handleClaimStep = (eventId) => {
                const result = gameManager.advanceClaimStep(playerId, eventId);
                
                if (result.waiting) {
                    setClaimMessages(prev => ({
                        ...prev,
                        [eventId]: { type: 'wait', text: `Please wait ${result.remainingSeconds} seconds...` }
                    }));
                } else if (result.failed) {
                    setClaimMessages(prev => ({
                        ...prev,
                        [eventId]: { type: 'error', text: `❌ ${result.message}` }
                    }));
                    setTimeout(() => {
                        setClaimMessages(prev => ({ ...prev, [eventId]: null }));
                    }, 3000);
                } else if (result.success) {
                    setClaimMessages(prev => ({
                        ...prev,
                        [eventId]: { type: 'success', text: `⏱️ Processing... (${result.waitSeconds}s)` }
                    }));
                    setTimeout(() => {
                        setClaimMessages(prev => ({ ...prev, [eventId]: null }));
                    }, 3000);
                }
                
                onUpdate();
            };

            const insuranceCost = Object.keys(player.insurance).reduce((sum, type) => sum + INSURANCE_TYPES[type].monthlyCost, 0);

            return (
                <div className="container">
                    {/* Insurance Information Popup */}
                    {showInsuranceInfo && INSURANCE_INFO[showInsuranceInfo] && (
                        <>
                            <div className="event-overlay" onClick={() => setShowInsuranceInfo(null)}></div>
                            <div className="event-popup" style={{ maxWidth: '600px' }}>
                                <div className="event-title" style={{ fontSize: '2em' }}>
                                    {INSURANCE_INFO[showInsuranceInfo].title}
                                </div>
                                
                                <div style={{ textAlign: 'left', marginTop: '20px' }}>
                                    <h3 style={{ color: '#667eea', marginBottom: '10px' }}>What It Covers:</h3>
                                    <p style={{ marginBottom: '20px', lineHeight: '1.6' }}>
                                        {INSURANCE_INFO[showInsuranceInfo].whatItCovers}
                                    </p>

                                    <h3 style={{ color: '#667eea', marginBottom: '10px' }}>Potential Costs Without Insurance:</h3>
                                    <div style={{ 
                                        background: '#fff3e0', 
                                        padding: '15px', 
                                        borderRadius: '8px',
                                        marginBottom: '20px',
                                        border: '2px solid #ff9800'
                                    }}>
                                        {INSURANCE_INFO[showInsuranceInfo].potentialCosts.map((item, i) => (
                                            <div key={i} style={{ 
                                                display: 'flex', 
                                                justifyContent: 'space-between',
                                                marginBottom: '8px',
                                                paddingBottom: '8px',
                                                borderBottom: i < INSURANCE_INFO[showInsuranceInfo].potentialCosts.length - 1 ? '1px solid #ffe0b2' : 'none'
                                            }}>
                                                <span>{item.event}</span>
                                                <strong style={{ color: '#dc3545' }}>{item.cost}</strong>
                                            </div>
                                        ))}
                                    </div>

                                    <h3 style={{ color: '#667eea', marginBottom: '10px' }}>Why You Need It:</h3>
                                    <p style={{ marginBottom: '20px', lineHeight: '1.6' }}>
                                        {INSURANCE_INFO[showInsuranceInfo].whyYouNeedIt}
                                    </p>

                                    <h3 style={{ color: '#667eea', marginBottom: '10px' }}>Choosing Your Policy:</h3>
                                    <p style={{ marginBottom: '20px', lineHeight: '1.6', fontSize: '0.95em' }}>
                                        {INSURANCE_INFO[showInsuranceInfo].budgetVsPremium}
                                    </p>
                                </div>

                                <button 
                                    style={{ marginTop: '10px', width: '100%' }}
                                    onClick={() => setShowInsuranceInfo(null)}
                                >
                                    Close
                                </button>
                            </div>
                        </>
                    )}

                    {/* Event Popup */}
                    {showEventPopup && currentEvent && (
                        <>
                            <div className="event-overlay" onClick={() => setShowEventPopup(false)}></div>
                            <div className="event-popup">
                                <div className="event-title">
                                    {currentEvent.cost > 0 ? '⚠️ Event Occurred!' : '⚠️ Event Occurred!'}
                                </div>
                                <h3 style={{ margin: '20px 0', fontSize: '1.5em' }}>{currentEvent.name}</h3>
                                
                                {currentEvent.covered ? (
                                    <div>
                                        <div style={{ fontSize: '1.2em', color: '#666', marginBottom: '10px' }}>
                                            Original Cost: <span style={{ textDecoration: 'line-through' }}>£{currentEvent.cost.toLocaleString()}</span>
                                        </div>
                                        <div className="event-cost covered">
                                            You Pay Now: £{currentEvent.actualCost.toLocaleString()}
                                        </div>
                                            {currentEvent.needsClaim ? (
                                                <div style={{ 
                                                    fontSize: '1em', 
                                                    color: '#ff9800', 
                                                    marginTop: '15px',
                                                    padding: '15px',
                                                    background: '#fff3e0',
                                                    borderRadius: '8px',
                                                    border: '2px solid #ff9800'
                                                }}>
                                                    <strong>⚠️ Claims Process Required</strong>
                                                    <div style={{ marginTop: '8px', fontSize: '0.9em' }}>
                                                        You paid the excess upfront. To get your refund of <strong>£{(currentEvent.cost - currentEvent.actualCost).toLocaleString()}</strong>, you need to complete the claims process.
                                                    </div>
                                                    {currentEvent.insuranceUsed && INSURANCE_TYPES[currentEvent.insuranceUsed] && (
                                                        <div style={{ marginTop: '8px', fontSize: '0.9em' }}>
                                                            Your insurer rating: {renderStars(INSURANCE_TYPES[currentEvent.insuranceUsed].starRating)}
                                                        </div>
                                                    )}
                                                    <div style={{ marginTop: '8px', fontSize: '0.85em', color: '#666' }}>
                                                        Check "Pending Insurance Claims" section below.
                                                    </div>
                                                </div>
                                            ) : (
                                                <div style={{ fontSize: '1.1em', color: '#28a745', marginTop: '10px' }}>
                                                    ✓ {renderStars(5)} Premium Insurance - Claim Paid Instantly!
                                                    <div style={{ fontSize: '0.9em', marginTop: '5px' }}>
                                                        Saved: £{(currentEvent.cost - currentEvent.actualCost).toLocaleString()}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div>
                                            <div className="event-cost">
                                                You Pay: £{currentEvent.actualCost.toLocaleString()}
                                            </div>
                                            <div style={{ fontSize: '1.1em', color: '#dc3545', marginTop: '10px' }}>
                                                ❌ Not covered by insurance
                                            </div>
                                        </div>
                                    )}

                                <button 
                                    style={{ marginTop: '20px', width: '100%' }}
                                    onClick={() => setShowEventPopup(false)}
                                >
                                    OK
                                </button>
                            </div>
                        </>
                    )}
                    <div className="card">
                        <h2>Welcome, {player.name}!</h2>
                        {!game.started && (
                            <div className="game-info">
                                <p>⏳ Waiting for teacher to start the game...</p>
                                <p>Room Code: {game.code}</p>
                            </div>
                        )}
                        {game.started && (
                            <div>
                                <div className="month-indicator">
                                    Month {game.currentMonth} of {GAME_CONFIG.monthsPerGame}
                                </div>
                                <div className="stats-grid">
                                    <div className="stat-card">
                                        <div className="stat-label">Balance</div>
                                        <div className="stat-value">£{player.balance.toLocaleString()}</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-label">Monthly Income</div>
                                        <div className="stat-value">£{GAME_CONFIG.monthlyIncome}</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-label">Insurance Cost</div>
                                        <div className="stat-value">£{insuranceCost}</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-label">Policies</div>
                                        <div className="stat-value">{Object.keys(player.insurance).length}</div>
                                    </div>
                                </div>

                                <h3>🛡️ Insurance Shop</h3>
                                <p style={{ fontSize: '0.9em', color: '#666', marginBottom: '15px' }}>
                                    You can only have one insurance policy per category. Buying a new one will replace your current policy.
                                </p>
                                <div className="insurance-shop">
                                    {Object.entries(
                                        Object.entries(INSURANCE_TYPES).reduce((acc, [type, insurance]) => {
                                            if (!acc[insurance.category]) acc[insurance.category] = [];
                                            acc[insurance.category].push({ type, ...insurance });
                                            return acc;
                                        }, {})
                                    ).map(([category, options]) => (
                                        <div key={category} style={{ 
                                            gridColumn: options.length > 2 ? 'span 2' : 'auto',
                                            border: '2px solid #e0e0e0',
                                            borderRadius: '12px',
                                            padding: '15px',
                                            background: '#f8f9fa'
                                        }}>
                                            <h4 style={{ 
                                                textTransform: 'capitalize', 
                                                marginBottom: '15px',
                                                color: '#667eea',
                                                fontSize: '1.2em',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'space-between'
                                            }}>
                                                <span>{category} Insurance</span>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setShowInsuranceInfo(category);
                                                    }}
                                                    style={{
                                                        background: '#667eea',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '50%',
                                                        width: '28px',
                                                        height: '28px',
                                                        fontSize: '0.9em',
                                                        cursor: 'pointer',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        padding: 0
                                                    }}
                                                    title="Learn more about this insurance"
                                                >
                                                    ℹ️
                                                </button>
                                            </h4>
                                            <div style={{ 
                                                display: 'grid', 
                                                gridTemplateColumns: `repeat(${Math.min(options.length, 3)}, 1fr)`,
                                                gap: '10px'
                                            }}>
                                                {options.map(insurance => (
                                                    <div key={insurance.type} className={`insurance-card ${player.insurance[insurance.type] ? 'owned' : ''}`}>
                                                        <h5 style={{ fontSize: '0.95em', marginBottom: '8px' }}>
                                                            {category === 'car' ? (
                                                                insurance.type === 'car_third_party' ? '🚗 Third Party Only' :
                                                                insurance.type === 'car_tpft' ? '🔥 TP Fire & Theft' :
                                                                '✨ Fully Comprehensive'
                                                            ) : (
                                                                <>
                                                                    {insurance.brand === 'budget' && '💰 '}
                                                                    {insurance.brand === 'basic' && '💰 '}
                                                                    {insurance.brand === 'standard' && '⭐ '}
                                                                    {insurance.brand === 'premium' && '✨ '}
                                                                    {insurance.brand.charAt(0).toUpperCase() + insurance.brand.slice(1)}
                                                                </>
                                                            )}
                                                        </h5>
                                                        <div className="insurance-price">£{insurance.monthlyCost}/mo</div>
                                                        <div className="insurance-coverage">Excess: £{insurance.deductible}</div>
                                                        {insurance.description && (
                                                            <div className="insurance-coverage" style={{ fontSize: '0.75em', fontStyle: 'italic', marginTop: '5px' }}>
                                                                {insurance.description}
                                                            </div>
                                                        )}
                                                        <div className="insurance-coverage" style={{ fontSize: '1.1em', marginTop: '5px' }}>
                                                            Claims: {renderStars(insurance.starRating)}
                                                        </div>
                                                        {!player.insurance[insurance.type] ? (
                                                            <button 
                                                                style={{ marginTop: '10px', width: '100%', fontSize: '0.85em', padding: '8px' }}
                                                                onClick={() => {
                                                                    gameManager.buyInsurance(playerId, insurance.type);
                                                                    onUpdate();
                                                                }}
                                                            >
                                                                Buy
                                                            </button>
                                                        ) : (
                                                            <button 
                                                                className="btn-danger"
                                                                style={{ marginTop: '10px', width: '100%', fontSize: '0.85em', padding: '8px' }}
                                                                onClick={() => {
                                                                    gameManager.cancelInsurance(playerId, insurance.type);
                                                                    onUpdate();
                                                                }}
                                                            >
                                                                ✓ Active
                                                            </button>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {player.pendingClaims && player.pendingClaims.filter(c => !c.completed).length > 0 && (
                                    <div>
                                        <h3>📝 Pending Insurance Claims</h3>
                                        <p style={{ fontSize: '0.9em', color: '#666', marginBottom: '10px' }}>
                                            Complete each step to process your claim. Lower-rated insurers ({renderStars(1)}) require more steps and may lose documentation.
                                        </p>
                                        {player.pendingClaims.filter(c => !c.completed).map((claim, idx) => {
                                            const event = player.events.find(e => e.id === claim.eventId);
                                            const insuranceUsed = INSURANCE_TYPES[event?.insuranceUsed];
                                            const currentStepData = claim.steps[claim.currentStep];
                                            const timeRemaining = claimTimers[claim.eventId] || 0;
                                            const canClick = timeRemaining === 0;
                                            const message = claimMessages[claim.eventId];
                                            
                                            return (
                                                <div key={idx} className="game-info" style={{ marginBottom: '15px' }}>
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '10px' }}>
                                                        <div>
                                                            <strong>{event?.name || 'Claim'}</strong>
                                                            {insuranceUsed && (
                                                                <div style={{ fontSize: '0.85em', color: '#667eea', marginTop: '4px' }}>
                                                                    Insurer rating: {renderStars(insuranceUsed.starRating)}
                                                                </div>
                                                            )}
                                                            {claim.stepAttempts > 0 && (
                                                                <span style={{ 
                                                                    display: 'block',
                                                                    marginTop: '4px', 
                                                                    color: '#ff9800', 
                                                                    fontSize: '0.85em' 
                                                                }}>
                                                                    ⚠️ {claim.stepAttempts} failed {claim.stepAttempts === 1 ? 'attempt' : 'attempts'}
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div style={{ textAlign: 'right' }}>
                                                            Refund: <strong style={{ color: '#28a745' }}>£{claim.refundAmount.toLocaleString()}</strong>
                                                        </div>
                                                    </div>
                                                    
                                                    <div style={{ 
                                                        background: '#fff',
                                                        padding: '15px',
                                                        borderRadius: '8px',
                                                        marginTop: '10px'
                                                    }}>
                                                        <div style={{ marginBottom: '10px', fontSize: '0.9em', color: '#666' }}>
                                                            Progress: Step {claim.currentStep + 1} of {claim.steps.length}
                                                        </div>
                                                        <div style={{ 
                                                            background: '#e0e0e0',
                                                            height: '20px',
                                                            borderRadius: '10px',
                                                            overflow: 'hidden',
                                                            marginBottom: '15px'
                                                        }}>
                                                            <div style={{ 
                                                                background: 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)',
                                                                height: '100%',
                                                                width: `${(claim.currentStep / claim.steps.length) * 100}%`,
                                                                transition: 'width 0.3s'
                                                            }}></div>
                                                        </div>
                                                        
                                                        <div style={{ 
                                                            padding: '12px',
                                                            background: claim.failMessage ? '#fff3cd' : '#f8f9fa',
                                                            borderRadius: '6px',
                                                            marginBottom: '10px',
                                                            fontSize: '0.95em',
                                                            border: claim.failMessage ? '2px solid #ff9800' : 'none'
                                                        }}>
                                                            {currentStepData.text}
                                                            {claim.failMessage && (
                                                                <div style={{ 
                                                                    marginTop: '8px', 
                                                                    color: '#ff9800',
                                                                    fontWeight: 'bold',
                                                                    fontSize: '0.9em'
                                                                }}>
                                                                    {claim.failMessage}
                                                                </div>
                                                            )}
                                                        </div>

                                                        {timeRemaining > 0 && (
                                                            <div style={{ 
                                                                padding: '10px',
                                                                background: '#e3f2fd',
                                                                borderRadius: '6px',
                                                                marginBottom: '10px',
                                                                textAlign: 'center',
                                                                fontSize: '1.1em',
                                                                fontWeight: 'bold',
                                                                color: '#1976d2'
                                                            }}>
                                                                ⏱️ Please wait: {timeRemaining}s
                                                            </div>
                                                        )}

                                                        {message && (
                                                            <div style={{ 
                                                                padding: '10px',
                                                                background: message.type === 'error' ? '#ffebee' : 
                                                                          message.type === 'success' ? '#e8f5e9' : '#fff3e0',
                                                                borderRadius: '6px',
                                                                marginBottom: '10px',
                                                                color: message.type === 'error' ? '#c62828' : 
                                                                       message.type === 'success' ? '#2e7d32' : '#ef6c00',
                                                                fontSize: '0.9em',
                                                                textAlign: 'center'
                                                            }}>
                                                                {message.text}
                                                            </div>
                                                        )}
                                                        
                                                        <button
                                                            onClick={() => handleClaimStep(claim.eventId)}
                                                            style={{ width: '100%' }}
                                                            disabled={!canClick}
                                                        >
                                                            {!canClick ? `⏱️ Wait ${timeRemaining}s` :
                                                             claim.failMessage ? 'Try Again' :
                                                             claim.currentStep === claim.steps.length - 1 ? '✓ Complete Claim' : 
                                                             'Next Step →'}
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}

                                {player.events.length > 0 && (
                                    <div>
                                        <h3>📋 Recent Events</h3>
                                        <div>
                                            {player.events.slice(-5).reverse().map((event, i) => (
                                                <div key={i} className="game-info" style={{ marginBottom: '10px' }}>
                                                    <strong>{event.name}</strong><br />
                                                    {event.covered ? (
                                                        <span style={{ color: '#28a745' }}>
                                                            ✓ Covered! You paid £{event.actualCost} (Insurance saved £{event.cost - event.actualCost})
                                                        </span>
                                                    ) : (
                                                        <span style={{ color: '#dc3545' }}>
                                                            You paid £{event.actualCost}
                                                        </span>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function DisplayScreen({ gameState, onBack, onUpdate }) {
            const [showEventPopup, setShowEventPopup] = useState(false);
            const [displayEvents, setDisplayEvents] = useState([]);

            const game = gameState;
            if (!game) {
                return (
                    <div className="container">
                        <div className="card">
                            <h2>Loading game data...</h2>
                            <p>Connecting to Firebase...</p>
                        </div>
                    </div>
                );
            }
            
            if (!game.players) {
                game.players = {};
            }

            // Check for new display events
            useEffect(() => {
                if (game.lastSharedEvent) {
                    setDisplayEvents(game.recentDisplayEvents || []);
                    setShowEventPopup(true);
                    
                    // Auto-close after 15 seconds
                    const timer = setTimeout(() => {
                        setShowEventPopup(false);
                    }, 15000);
                    
                    return () => clearTimeout(timer);
                }
            }, [game.lastSharedEvent, game.currentMonth]);

            const playerCount = Object.keys(game.players).length;
            const sortedPlayers = Object.values(game.players).sort((a, b) => b.balance - a.balance);
            const avgBalance = playerCount > 0 ? Math.round(sortedPlayers.reduce((sum, p) => sum + p.balance, 0) / playerCount) : 0;
            const insuredCount = sortedPlayers.filter(p => Object.keys(p.insurance).length > 0).length;

            return (
                <div className="display-screen">
                    {showEventPopup && game.lastSharedEvent && (
                        <>
                            <div className="event-overlay" onClick={() => setShowEventPopup(false)}></div>
                            <div className="event-popup" style={{ maxWidth: '900px', maxHeight: '85vh', overflowY: 'auto' }}>
                                <div className="event-title" style={{ fontSize: '2.5em', marginBottom: '10px' }}>
                                    ⚡ EVENT!
                                </div>
                                
                                {/* Main Event Display */}
                                <div style={{ 
                                    padding: '30px',
                                    background: game.lastSharedEvent.cost > 10000 ? 
                                        'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)' : 
                                        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                    borderRadius: '12px',
                                    color: 'white',
                                    marginBottom: '25px',
                                    textAlign: 'center'
                                }}>
                                    <div style={{ fontSize: '2.5em', marginBottom: '15px' }}>
                                        {game.lastSharedEvent.name}
                                    </div>
                                    <div style={{ fontSize: '1.8em', fontWeight: 'bold' }}>
                                        Cost: £{game.lastSharedEvent.cost.toLocaleString()}
                                    </div>
                                </div>

                                {/* Individual Player Outcomes */}
                                <div>
                                    <h3 style={{ marginBottom: '15px', color: '#667eea' }}>
                                        How Each Student Was Affected:
                                    </h3>
                                    <div style={{ 
                                        display: 'grid', 
                                        gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
                                        gap: '12px',
                                        maxHeight: '400px',
                                        overflowY: 'auto',
                                        padding: '10px'
                                    }}>
                                        {displayEvents.length > 0 ? displayEvents.map((event, idx) => (
                                            <div key={idx} style={{ 
                                                padding: '12px',
                                                background: 'white',
                                                borderRadius: '8px',
                                                borderLeft: event.covered ? '5px solid #28a745' : '5px solid #dc3545',
                                                boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
                                            }}>
                                                <div style={{ 
                                                    fontWeight: 'bold',
                                                    color: '#667eea',
                                                    marginBottom: '8px',
                                                    fontSize: '1.05em'
                                                }}>
                                                    {event.playerName}
                                                </div>
                                                <div style={{ 
                                                    fontSize: '1.4em', 
                                                    fontWeight: 'bold',
                                                    color: event.covered ? '#28a745' : '#dc3545',
                                                    marginBottom: '4px'
                                                }}>
                                                    £{event.actualCost.toLocaleString()}
                                                </div>
                                                <div style={{ 
                                                    fontSize: '0.85em',
                                                    color: '#666',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '5px'
                                                }}>
                                                    {event.covered ? (
                                                        <>
                                                            <span style={{ color: '#28a745' }}>✓</span>
                                                            {event.needsClaim ? 'Insured (claim needed)' : 'Insured'}
                                                        </>
                                                    ) : (
                                                        <>
                                                            <span style={{ color: '#dc3545' }}>✗</span>
                                                            Not insured
                                                        </>
                                                    )}
                                                </div>
                                                {event.covered && (
                                                    <div style={{ 
                                                        fontSize: '0.8em',
                                                        color: '#28a745',
                                                        marginTop: '4px'
                                                    }}>
                                                        Saved: £{(event.cost - event.actualCost).toLocaleString()}
                                                    </div>
                                                )}
                                            </div>
                                        )) : (
                                            <div style={{ 
                                                gridColumn: '1 / -1',
                                                textAlign: 'center',
                                                padding: '20px',
                                                color: '#666'
                                            }}>
                                                No players in game yet
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <button 
                                    style={{ marginTop: '20px', width: '100%', fontSize: '1.1em', padding: '15px' }}
                                    onClick={() => setShowEventPopup(false)}
                                >
                                    Close
                                </button>
                            </div>
                        </>
                    )}
                    <div className="display-header" style={{ padding: '15px 30px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h1 style={{ fontSize: '1.8em', margin: 0 }}>🛡️ Life Happens</h1>
                            {game.started && <div style={{ fontSize: '1.5em', fontWeight: 'bold' }}>
                                Month {game.currentMonth} / {GAME_CONFIG.monthsPerGame}
                            </div>}
                            {!game.started && <div className="room-code" style={{ 
                                fontSize: '2em', 
                                padding: '10px 20px',
                                margin: 0,
                                letterSpacing: '6px'
                            }}>{game.code}</div>}
                        </div>
                    </div>

                    <div className="container" style={{ paddingTop: '10px' }}>
                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '20px', paddingBottom: '80px' }}>
                            <div className="card">
                                <h2>🏆 Leaderboard</h2>
                                <div className="leaderboard">
                                    {sortedPlayers.length === 0 ? (
                                        <p style={{ textAlign: 'center', color: '#666', padding: '40px' }}>
                                            Waiting for players to join...
                                        </p>
                                    ) : (
                                        sortedPlayers.map((player, index) => (
                                            <div key={player.id} className={`leaderboard-item ${index < 3 ? 'top-3' : ''}`}>
                                                <span className="rank">
                                                    {index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`}
                                                </span>
                                                <span className="player-name">{player.name}</span>
                                                <span className="player-balance">£{player.balance.toLocaleString()}</span>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>

                            {game.started && (
                                <div className="card">
                                    <h2>📰 Recent Events</h2>
                                    <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                                        {/* Show recent shared events */}
                                        {game.lastSharedEvent ? (
                                            <div style={{ 
                                                padding: '15px', 
                                                marginBottom: '12px', 
                                                background: game.lastSharedEvent.cost > 10000 ? '#fff3cd' : '#e7f3ff',
                                                borderRadius: '8px',
                                                borderLeft: game.lastSharedEvent.cost > 10000 ? '4px solid #ff6b6b' : '4px solid #667eea'
                                            }}>
                                                <div style={{ fontSize: '1.1em', fontWeight: 'bold', marginBottom: '8px', color: '#333' }}>
                                                    Month {game.currentMonth - 1}: {game.lastSharedEvent.name}
                                                </div>
                                                <div style={{ fontSize: '1.3em', fontWeight: 'bold', color: '#dc3545' }}>
                                                    £{game.lastSharedEvent.cost.toLocaleString()} to replace/repair
                                                </div>
                                                {game.recentDisplayEvents && game.recentDisplayEvents.length > 0 && (
                                                    <div style={{ marginTop: '10px', fontSize: '0.85em', color: '#666' }}>
                                                        <strong>Class Impact:</strong>
                                                        <div style={{ marginTop: '5px' }}>
                                                            {game.recentDisplayEvents.filter(e => e.covered).length} students insured, {' '}
                                                            {game.recentDisplayEvents.filter(e => !e.covered).length} uninsured
                                                        </div>
                                                        <div>
                                                            Average paid: £{Math.round(
                                                                game.recentDisplayEvents.reduce((sum, e) => sum + e.actualCost, 0) / 
                                                                game.recentDisplayEvents.length
                                                            ).toLocaleString()}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ) : (
                                            <div>
                                                <p style={{ textAlign: 'center', color: '#666', padding: '20px' }}>
                                                    {game.currentMonth === 1 ? 
                                                        'No events yet - click "Next Month" to begin!' :
                                                        `Month ${game.currentMonth - 1}: No events occurred`
                                                    }
                                                </p>
                                            </div>
                                        )}
                                        
                                        {/* Show history of previous events if we want to track them */}
                                        {game.eventHistory && game.eventHistory.slice(0, 5).map((histEvent, i) => (
                                            <div key={i} style={{ 
                                                padding: '12px', 
                                                marginBottom: '8px', 
                                                background: '#f8f9fa',
                                                borderRadius: '6px',
                                                fontSize: '0.9em',
                                                borderLeft: '3px solid #ccc'
                                            }}>
                                                <div style={{ fontWeight: 'bold', color: '#666' }}>
                                                    Month {histEvent.month}: {histEvent.name}
                                                </div>
                                                <div style={{ color: '#999', fontSize: '0.85em' }}>
                                                    £{histEvent.cost.toLocaleString()}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Game control button in bottom corner */}
                        <div style={{ 
                            position: 'fixed', 
                            bottom: '20px', 
                            right: '20px',
                            zIndex: 100
                        }}>
                            {!game.started ? (
                                <div>
                                    <button 
                                        style={{ fontSize: '1em', padding: '12px 24px', marginBottom: '10px', display: 'block' }}
                                        onClick={() => {
                                            gameManager.startGame();
                                            onUpdate();
                                        }}
                                    >
                                        ▶️ Start Game
                                    </button>
                                    <button 
                                        className="btn-danger"
                                        style={{ fontSize: '0.9em', padding: '8px 16px' }}
                                        onClick={() => {
                                            if (confirm('Reset game? This will remove all players and start fresh.')) {
                                                gameManager.resetGame();
                                                onUpdate();
                                            }
                                        }}
                                    >
                                        🔄 Reset Game
                                    </button>
                                </div>
                            ) : (
                                <div>
                                    {game.currentMonth <= GAME_CONFIG.monthsPerGame && (
                                        <button 
                                            style={{ fontSize: '1em', padding: '12px 24px' }}
                                            onClick={() => {
                                                gameManager.advanceMonth();
                                                onUpdate();
                                            }}
                                        >
                                            Next Month ⏭️
                                        </button>
                                    )}
                                    {game.currentMonth > GAME_CONFIG.monthsPerGame && (
                                        <button 
                                            style={{ fontSize: '1em', padding: '12px 24px' }}
                                            onClick={onBack}
                                        >
                                            End Game
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<App />);
    </script>
</body>
</html>
